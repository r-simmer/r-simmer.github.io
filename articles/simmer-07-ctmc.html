<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Continuous-Time Markov Chains • simmer | DES for R</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Continuous-Time Markov Chains">
<meta property="og:description" content="simmer">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115358925-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115358925-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">simmer | DES for R</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">4.4.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href=".././">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-gears"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-graduation-cap"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/simmer-01-introduction.html">Introduction to simmer</a>
    </li>
    <li>
      <a href="../articles/simmer-02-jss.pdf">JSS paper (PDF)</a>
    </li>
    <li>
      <a href="../articles/simmer-03-trajectories.html">Advanced Trajectory Usage</a>
    </li>
    <li>
      <a href="../articles/simmer-04-bank-1.html">The Bank Tutorial: Part I</a>
    </li>
    <li>
      <a href="../articles/simmer-04-bank-2.html">The Bank Tutorial: Part II</a>
    </li>
    <li>
      <a href="../articles/simmer-05-simpy.html">Other SimPy Examples</a>
    </li>
    <li>
      <a href="../articles/simmer-06-queueing.html">Queueing Systems</a>
    </li>
    <li>
      <a href="../articles/simmer-07-ctmc.html">Continuous-Time Markov Chains</a>
    </li>
    <li>
      <a href="../articles/simmer-08-philosophers.html">Dining Philosophers Problem</a>
    </li>
    <li>
      <a href="../articles/simmer-aa-5G.html">Design and Analysis of 5G Scenarios</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/r-simmer/simmer">
    <span class="fa fa-github"></span>
     
    GitHub
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-puzzle-piece"></span>
     
    Extensions
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../extensions/plot">simmer.plot</a>
    </li>
    <li>
      <a href="../extensions/bricks">simmer.bricks</a>
    </li>
    <li>
      <a href="https://github.com/r-simmer/simmer.optim">simmer.optim</a>
    </li>
    <li>
      <a href="https://github.com/r-simmer/simmer.json">simmer.json</a>
    </li>
    <li>
      <a href="https://github.com/r-simmer/simmer.mon">simmer.mon</a>
    </li>
  </ul>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="simmer-07-ctmc_files/header-attrs-2.10/header-attrs.js"></script><script src="simmer-07-ctmc_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Continuous-Time Markov Chains</h1>
                        <h4 class="author">Iñaki Ucar</h4>
            
            <h4 class="date">2021-08-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/r-simmer/simmer/blob/master/vignettes/simmer-07-ctmc.Rmd"><code>vignettes/simmer-07-ctmc.Rmd</code></a></small>
      <div class="hidden name"><code>simmer-07-ctmc.Rmd</code></div>

    </div>

    
    
<script type="text/x-mathjax-config">
  MathJax.Ajax.config.path["Contrib"] = "https://cdn.mathjax.org/mathjax/contrib";
  MathJax.Hub.Config({
    TeX: {extensions: ["[Contrib]/xyjax/xypic.js","AMSmath.js","AMSsymbols.js"]},
    tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]}
  });
</script><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-simmer.org">simmer</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://r-simmer.org">simmer.plot</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></code></pre></div>
<div id="example-1" class="section level2">
<h2 class="hasAnchor">
<a href="#example-1" class="anchor"></a>Example 1</h2>
<p>A gas station has a single pump and no space for vehicles to wait (if a vehicle arrives and the pump is not available, it leaves). Vehicles arrive to the gas station following a Poisson process with a rate of <span class="math inline">\(\lambda=3/20\)</span> vehicles per minute, of which 75% are cars and 25% are motorcycles. The refuelling time can be modelled with an exponential random variable with mean 8 minutes for cars and 3 minutes for motorcycles, that is, the services rates are <span class="math inline">\(\mu_\mathrm{c}=1/8\)</span> cars and <span class="math inline">\(\mu_\mathrm{m}=1/3\)</span> motorcycles per minute respectively.</p>
<p>This problem is described by the following continuous-time Markov chain:</p>
<p><span class="math display">\[\xymatrix{
*=&lt;15mm,8mm&gt;[o][F]{car} \ar@/^/[r]^{\mu_\mathrm{c}} &amp;
*=&lt;15mm,8mm&gt;[o][F]{empty} \ar@/^/[l]^{p\lambda} \ar@/^/[r]^{(1-p)\lambda}  &amp;
*=&lt;15mm,8mm&gt;[o][F]{m/cycle} \ar@/^/[l]^{\mu_\mathrm{m}}
}\qquad\qquad
Q = \begin{pmatrix}
-\mu_\mathrm{c} &amp; \mu_\mathrm{c} &amp; 0 \\
p\lambda &amp; -\lambda &amp; (1-p) \lambda \\
0 &amp; \mu_\mathrm{m} &amp; -\mu_\mathrm{m} 
\end{pmatrix}\]</span></p>
<p>with <span class="math inline">\(p=0.75\)</span>. The chain is irreducible and recurrent. To theoretically find the steady state distribution, we have to solve the balance equations</p>
<p><span class="math display">\[pQ = 0\]</span></p>
<p>with the constraint</p>
<p><span class="math display">\[\sum_i p_i = 1\]</span></p>
<p>There are <span class="math inline">\(\operatorname{dim}(Q)-1\)</span> independent columns, so the latter constraint is equivalent to substitute any column by ones and match it to one at the other side of the equation, that is:</p>
<p><span class="math display">\[p\cdot\begin{pmatrix}
1 &amp; 1/8 &amp; 0 \\
1 &amp; -3/20 &amp; 0.25\cdot 3/20 \\
1 &amp; 1/3 &amp; -1/3 
\end{pmatrix} = (1, 0, 0)\]</span></p>
<p>The solution <span class="math inline">\(p\)</span> represents the probability of being at each state in the long-term. Therefore, we can calculate the average number of vehicles in the system by summing these probabilities multiplied by the number of vehicles at each state. In our case,</p>
<p><span class="math display">\[N = 1\cdot p_1 + 0\cdot p_2 + 1\cdot p_3\]</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Arrival rate</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">3</span><span class="op">/</span><span class="fl">20</span>
<span class="co"># Service rate (cars, motorcycles)</span>
<span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">8</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>
<span class="co"># Probability of car</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.75</span>

<span class="co"># Theoretical resolution</span>
<span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,   <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,            <span class="fl">0</span>,
              <span class="fl">1</span>, <span class="op">-</span><span class="va">lambda</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span>,
              <span class="fl">1</span>,   <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,       <span class="op">-</span><span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, byrow<span class="op">=</span><span class="cn">T</span>, ncol<span class="op">=</span><span class="fl">3</span><span class="op">)</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>
<span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="va">B</span><span class="op">)</span>
<span class="va">N_average_theor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">P</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> ; <span class="va">N_average_theor</span>
<span class="co">#&gt; [1] 0.5031056</span></code></pre></div>
<p>Now, we are going to simulate the system with <code>simmer</code> and verify that it converges to the theoretical solution. There are various options for selecting the model. As a first approach, due to the properties of Poisson processes, we can break down the problem into two trajectories (one for each type of vehicle), which differ in their service time only, and therefore two generators with rates <span class="math inline">\(\lambda_\mathrm{c} = p\lambda\)</span> and <span class="math inline">\(\lambda_\mathrm{m} = (1-p)\lambda\)</span>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">car</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  
  <span class="va">mcycle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  
  <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">1</span>, queue_size<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"car"</span>, <span class="va">car</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">*</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"mcycle"</span>, <span class="va">mcycle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Other arrival processes may not have this property, so we would define a single generator for all kind of vehicles and a single trajectory as follows. In order to distinguish between cars and motorcycles, we could define a branch after seizing the resource to select the proper service time.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">vehicle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/branch.html">branch</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">T</span><span class="op">)</span>, 
           <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="st">"car"</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
           <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="st">"mcycle"</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  
  <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">1</span>, queue_size<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"vehicle"</span>, <span class="va">vehicle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>But this option adds an unnecessary overhead since there is an additional call to an R function to select the branch, and therefore performance decreases. A much better option is to select the service time directly inside the <code>timeout</code> function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">vehicle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>  <span class="co"># car</span>
      <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>               <span class="co"># mcycle</span>
    <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  
  <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">1</span>, queue_size<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"vehicle"</span>, <span class="va">vehicle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This <code>option.3</code> is equivalent to <code>option.1</code> in terms of performance. But, of course, the three of them lead us to the same result. For instance,</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gas.station</span> <span class="op">&lt;-</span> <span class="fu">option.3</span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span>

<span class="co"># Evolution + theoretical value</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_mon.html">get_mon_resources</a></span><span class="op">(</span><span class="va">gas.station</span><span class="op">)</span>, <span class="st">"usage"</span>, <span class="st">"pump"</span>, items<span class="op">=</span><span class="st">"system"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">N_average_theor</span><span class="op">)</span></code></pre></div>
<p><img src="simmer-07-ctmc_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></p>
<p>And these are some performance results:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span>

<span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">1000</span><span class="op">/</span><span class="va">lambda</span>
<span class="va">tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">option.1</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, 
                     <span class="fu">option.2</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, 
                     <span class="fu">option.3</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span>
<span class="fu">autoplot</span><span class="op">(</span><span class="va">tm</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_y_log10</span><span class="op">(</span>breaks<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">limits</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/pretty.html">pretty</a></span><span class="op">(</span><span class="va">limits</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Time [milliseconds]"</span><span class="op">)</span></code></pre></div>
<div style="text-align:center">
<img src="includes/ctmc-1.png">
</div>
</div>
<div id="example-2" class="section level2">
<h2 class="hasAnchor">
<a href="#example-2" class="anchor"></a>Example 2</h2>
<p>Let us complicate things a bit. Consider the previous example, but, this time, there is space for one motorcycle to wait while the pump is being used by another vehicle. In other words, cars see a queue size of 0 and motorcycles see a queue size of 1.</p>
<p>The new Markov chain is the following:</p>
<p><span class="math display">\[\vcenter{\xymatrix{
*=&lt;15mm,8mm&gt;[o][F]{car+} \ar@(r,u)[drr]^{\mu_\mathrm{c}} \\
*=&lt;15mm,8mm&gt;[o][F]{car} \ar@/_/[r]_{\mu_\mathrm{c}} \ar@/^/[u]^{(1-p)\lambda} &amp;
*=&lt;15mm,8mm&gt;[o][F]{empty} \ar@/_/[l]_{p\lambda} \ar@/^/[r]^{(1-p)\lambda} &amp;
*=&lt;15mm,8mm&gt;[o][F]{m/cycle} \ar@/^/[l]^{\mu_\mathrm{m}} \ar@/_/[d]_{(1-p)\lambda} \\
&amp; &amp; *=&lt;15mm,8mm&gt;[o][F]{m/c+} \ar@/_/[u]_{\mu_\mathrm{m}}
}}\]</span></p>
<p><span class="math display">\[Q = \begin{pmatrix}
-\mu_\mathrm{c} &amp; 0 &amp; 0 &amp; \mu_\mathrm{c} &amp; 0 \\
(1-p)\lambda &amp; -(1-p)\lambda-\mu_\mathrm{c} &amp; \mu_\mathrm{c} &amp; 0 &amp; 0 \\
0 &amp; p\lambda &amp; -\lambda &amp; (1-p)\lambda &amp; 0 \\
0 &amp; 0 &amp; \mu_\mathrm{m} &amp; -(1-p)\lambda-\mu_\mathrm{m} &amp; (1-p)\lambda \\
0 &amp; 0 &amp; 0 &amp; \mu_\mathrm{m} &amp; -\mu_\mathrm{m} \\
\end{pmatrix}\]</span></p>
<p>where the states <em>car+</em> and <em>m/c+</em> represent <em>car + waiting motorcycle</em> and <em>motorcycle + waiting motorcycle</em> respectively.</p>
<p>With <span class="math inline">\(p\)</span> the steady state distribution, the average number of vehicles in the system is given by</p>
<p><span class="math display">\[N = 2(p_1 + p_5) + p_2 + p_4\]</span></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Theoretical resolution</span>
<span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,                   <span class="fl">0</span>,       <span class="fl">0</span>,               <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,            <span class="fl">0</span>,
              <span class="fl">1</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span><span class="op">-</span><span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,   <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,                   <span class="fl">0</span>,            <span class="fl">0</span>,
              <span class="fl">1</span>,            <span class="va">p</span><span class="op">*</span><span class="va">lambda</span>, <span class="op">-</span><span class="va">lambda</span>,        <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span>,            <span class="fl">0</span>,
              <span class="fl">1</span>,                   <span class="fl">0</span>,   <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span><span class="op">-</span><span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span>,
              <span class="fl">1</span>,                   <span class="fl">0</span>,       <span class="fl">0</span>,               <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,       <span class="op">-</span><span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, 
            byrow<span class="op">=</span><span class="cn">T</span>, ncol<span class="op">=</span><span class="fl">5</span><span class="op">)</span>
<span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>
<span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="va">B</span><span class="op">)</span>
<span class="va">N_average_theor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">P</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> ; <span class="va">N_average_theor</span>
<span class="co">#&gt; [1] 0.6349615</span></code></pre></div>
<p>As in the first example, we can simulate this chain by breaking down the problem into two trajectories (one for each type of vehicle and service rate) and two generators. But in order to disallow cars to stay in the pump’s queue, we need to introduce a little trick in the cars’ <code>seize</code>: the argument <code>amount</code> is a function that returns 1 if the pump is vacant and 2 otherwise. This implies that the car gets rejected, because there is only one position in queue and that <code>seize</code> is requesting two positions. Note also that the environment <code>env</code> must be defined <strong>before</strong> running, as it is needed inside the trajectory.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">car</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="va">env</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/get_capacity.html">get_server_count</a></span><span class="op">(</span><span class="st">"pump"</span><span class="op">)</span><span class="op">)</span> <span class="fl">2</span>  <span class="co"># rejection</span>
      <span class="kw">else</span> <span class="fl">1</span>                                   <span class="co"># serve</span>
    <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  
  <span class="va">mcycle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  
  <span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">1</span>, queue_size<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"car"</span>, <span class="va">car</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">*</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"mcycle"</span>, <span class="va">mcycle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span>
  <span class="va">env</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The same idea using a branch, with a single generator and a single trajectory.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">vehicle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/branch.html">branch</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">F</span>, <span class="cn">F</span><span class="op">)</span>, 
           <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="st">"car"</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
               <span class="kw">if</span> <span class="op">(</span><span class="va">env</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/get_capacity.html">get_server_count</a></span><span class="op">(</span><span class="st">"pump"</span><span class="op">)</span><span class="op">)</span> <span class="fl">2</span>  <span class="co"># rejection</span>
               <span class="kw">else</span> <span class="fl">1</span>                                   <span class="co"># serve</span>
             <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,                 <span class="co"># always 1</span>
           <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="st">"mcycle"</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">1</span>, queue_size<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"vehicle"</span>, <span class="va">vehicle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">)</span><span class="op">)</span>
  <span class="va">env</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We may also avoid messing up things with branches and subtrajectories. We can decide the type of vehicle and set it as an attribute of the arrival with <code><a href="../reference/set_attribute.html">set_attribute()</a></code>. Then, those attributes can be retrieved using <code><a href="../reference/get_n_generated.html">get_attribute()</a></code>. Although the branch option is a little bit faster, this one is nicer, because there are no subtrajectories involved.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">vehicle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="st">"car"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/set_attribute.html">set_attribute</a></span><span class="op">(</span><span class="st">"vehicle"</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/get_n_generated.html">get_attribute</a></span><span class="op">(</span><span class="va">env</span>, <span class="st">"vehicle"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span>
          <span class="va">env</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/get_capacity.html">get_server_count</a></span><span class="op">(</span><span class="st">"pump"</span><span class="op">)</span><span class="op">)</span> <span class="fl">2</span>    <span class="co"># car rejection</span>
      <span class="kw">else</span> <span class="fl">1</span>                                     <span class="co"># serve</span>
    <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fu"><a href="../reference/get_n_generated.html">get_attribute</a></span><span class="op">(</span><span class="va">env</span>, <span class="st">"vehicle"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">1</span><span class="op">)</span>                    <span class="co"># always 1</span>
  
  <span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">1</span>, queue_size<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"vehicle"</span>, <span class="va">vehicle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">)</span><span class="op">)</span>
  <span class="va">env</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>But if performance is a requirement, we can play cleverly with the resource capacity and the queue size, and with the amounts requested in each <code>seize</code>, in order to model the problem without checking the status of the resource. Think about this:</p>
<ul>
<li>A resource with <code>capacity=3</code> and <code>queue_size=2</code>.</li>
<li>A car always tries to seize <code>amount=3</code>.</li>
<li>A motorcycle always tries to seize <code>amount=2</code>.</li>
</ul>
<p>In these conditions, we have the following possibilities:</p>
<ul>
<li>Pump empty.</li>
<li>One car (3 units) in the server [and optionally one motorcycle (2 units) in the queue].</li>
<li>One motorcycle (2 units) in the server [and optionally one motorcycle (2 units) in the queue].</li>
</ul>
<p>Just as expected! So, let’s try:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.4</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">vehicle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/branch.html">branch</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span>, prob<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">F</span>, <span class="cn">F</span><span class="op">)</span>, 
           <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="st">"car"</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">3</span><span class="op">)</span>,
           <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="st">"mcycle"</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
             <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">3</span>, queue_size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"vehicle"</span>, <span class="va">vehicle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We are still wasting time in the <code>branch</code> decision. We can mix this solution above with the <code>option.1</code> to gain extra performance:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">option.5</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">car</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">3</span><span class="op">)</span>
  
  <span class="va">mcycle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trajectory.html">trajectory</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">seize</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/timeout.html">timeout</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/seize.html">release</a></span><span class="op">(</span><span class="st">"pump"</span>, amount<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
  
  <span class="fu"><a href="../reference/simmer.html">simmer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="st">"pump"</span>, capacity<span class="op">=</span><span class="fl">3</span>, queue_size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"car"</span>, <span class="va">car</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">*</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/add_generator.html">add_generator</a></span><span class="op">(</span><span class="st">"mcycle"</span>, <span class="va">mcycle</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">*</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span>until<span class="op">=</span><span class="va">t</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Options 1, 2 and 3 are slower, but they give us the correct numbers, because the parameters (capacity, queue size, amounts) in the model remain unchanged compared to the problem. For instance,</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gas.station</span> <span class="op">&lt;-</span> <span class="fu">option.1</span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span>

<span class="co"># Evolution + theoretical value</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_mon.html">get_mon_resources</a></span><span class="op">(</span><span class="va">gas.station</span><span class="op">)</span>, <span class="st">"usage"</span>, <span class="st">"pump"</span>, items<span class="op">=</span><span class="st">"system"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">N_average_theor</span><span class="op">)</span></code></pre></div>
<p><img src="simmer-07-ctmc_files/figure-html/unnamed-chunk-15-1.png" width="576" style="display: block; margin: auto;"></p>
<p>However, it is not the case in options 4 and 5. The parameters of these models are <em>adulterated</em> to fit our performance purposes. Therefore, we need to extract the RAW data, rescale the numbers and plot them. And, of course, we get the same figure:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gas.station</span> <span class="op">&lt;-</span> <span class="fu">option.5</span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span>

<span class="fu"><a href="../reference/get_mon.html">get_mon_resources</a></span><span class="op">(</span><span class="va">gas.station</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span><span class="op">(</span>system <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">system</span> <span class="op">*</span> <span class="fl">2</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># rescaling</span>
  <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">system</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">time</span>, <span class="va">avg</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span>color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">expand_limits</span><span class="op">(</span>y<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title<span class="op">=</span><span class="st">"Resource usage: pump"</span>, x<span class="op">=</span><span class="st">"time"</span>, y<span class="op">=</span><span class="st">"in use"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">2</span>, lty<span class="op">=</span><span class="fl">2</span>, color<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept<span class="op">=</span><span class="va">N_average_theor</span><span class="op">)</span></code></pre></div>
<p><img src="simmer-07-ctmc_files/figure-html/unnamed-chunk-16-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Finally, these are some performance results:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span>

<span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">1000</span><span class="op">/</span><span class="va">lambda</span>
<span class="va">tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">option.1</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, 
                     <span class="fu">option.2</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, 
                     <span class="fu">option.3</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,
                     <span class="fu">option.4</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,
                     <span class="fu">option.5</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span>
<span class="fu">autoplot</span><span class="op">(</span><span class="va">tm</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_y_log10</span><span class="op">(</span>breaks<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">limits</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/pretty.html">pretty</a></span><span class="op">(</span><span class="va">limits</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Time [milliseconds]"</span><span class="op">)</span></code></pre></div>
<div style="text-align:center">
<img src="includes/ctmc-2.png">
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Iñaki Ucar, Bart Smeets.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
