<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Bank Tutorial: Part II • simmer</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">simmer | DES for R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-gears"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-graduation-cap"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/simmer-01-introduction.html">Introduction to simmer</a>
    </li>
    <li>
      <a href="../articles/simmer-02-terminology.html">Terminology</a>
    </li>
    <li>
      <a href="../articles/simmer-03-trajectories.html">Advanced Trajectory Usage</a>
    </li>
    <li>
      <a href="../articles/simmer-04-bank-1.html">The Bank Tutorial: Part I</a>
    </li>
    <li>
      <a href="../articles/simmer-04-bank-2.html">The Bank Tutorial: Part II</a>
    </li>
    <li>
      <a href="../articles/simmer-05-simpy.html">Other SimPy Examples</a>
    </li>
    <li>
      <a href="../articles/simmer-06-queueing.html">Queueing Systems</a>
    </li>
    <li>
      <a href="../articles/simmer-07-ctmc.html">Continuous-Time Markov Chains</a>
    </li>
    <li>
      <a href="../articles/simmer-08-philosophers.html">Dining Philosophers Problem</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-puzzle-piece"></span>
     
    Extensions
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="/extensions/plot">simmer.plot</a>
    </li>
    <li>
      <a href="/extensions/bricks">simmer.bricks</a>
    </li>
    <li>
      <a href="https://github.com/r-simmer/simmer.optim">simmer.optim</a>
    </li>
    <li>
      <a href="https://github.com/r-simmer/simmer.json">simmer.json</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-simmer/simmer">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>The Bank Tutorial: Part II</h1>
                        <h4 class="author">Duncan Garmonsway</h4>
            
            <h4 class="date">2018-01-04</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This tutorial is adapted from a tutorial for the Python 2 package ‘SimPy’, <a href="https://pythonhosted.org/SimPy/Tutorials/TheBank2.html">here</a>. Users familiar with SimPy may find this tutorial helpful for transitioning to simmer. Some very basic material is not covered. Beginners should first read the vignettes <a href="simmer-01-introduction.html"><em>Introduction to simmer</em></a>, <a href="simmer-02-terminology.html"><em>Terminology</em></a>, <a href="simmer-03-trajectories.html"><em>Advanced Trajectory Usage</em></a> and <a href="simmer-04-bank-1.html"><em>The Bank Tutorial: Part I</em></a>.</p>
</div>
<div id="priority-customers" class="section level2">
<h2 class="hasAnchor">
<a href="#priority-customers" class="anchor"></a>Priority customers</h2>
<p>In many situations there is a system of priority service. Those customers with high priority are served first, those with low priority must wait. In some cases, preemptive priority will even allow a high-priority customer to interrupt the service of one with a lower priority.</p>
<p>Simmer implements priority requests with an extra integer priority argument to <code><a href="../reference/add_generator.html">add_generator()</a></code>. By default, priority is zero; higher integers have higher priority. For this to operate, the resource must have been created with <code>preemptive = TRUE</code>.</p>
<div id="priority-customers-without-preemption" class="section level3">
<h3 class="hasAnchor">
<a href="#priority-customers-without-preemption" class="anchor"></a>Priority customers without preemption</h3>
<p>In the first example, we modify the program with random arrivals, one counter, and a fixed service time (like <em>One Service counter</em> in <em>The Bank Tutorial: Part I</em>) to process a high priority customer.</p>
<p>Here, we give each customer a priority. Since the default is <code>priority = 0</code> this is easy for most of them.</p>
<p>To observe the priority in action, while all other customers have the default priority of 0, we create and activate one special customer, Guido, with priority 1 who arrives at time 23. This is to ensure that he arrives after Customer2.</p>
<p>Since the activity trace does not produce the waiting time by default, this is calculated and appended using the <code>mutate</code> function in the dplyr package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1933</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {
         <span class="kw">paste</span>(<span class="st">"Queue is"</span>, <span class="kw"><a href="../reference/get_capacity.html">get_queue_count</a></span>(bank, <span class="st">"counter"</span>), <span class="st">"on arrival"</span>)
         }) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Completed"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Guido"</span>, customer, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">23</span>), <span class="dt">priority =</span> <span class="dv">1</span>)

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Queue is 0 on arrival</span>
<span class="co">#&gt; 0: Customer0: Waited 0</span>
<span class="co">#&gt; 0.177365: Customer1: Queue is 0 on arrival</span>
<span class="co">#&gt; 8.64106: Customer2: Queue is 1 on arrival</span>
<span class="co">#&gt; 12: Customer0: Completed</span>
<span class="co">#&gt; 12: Customer1: Waited 11.8226352687925</span>
<span class="co">#&gt; 21.1346: Customer3: Queue is 1 on arrival</span>
<span class="co">#&gt; 23: Guido0: Queue is 2 on arrival</span>
<span class="co">#&gt; 24: Customer1: Completed</span>
<span class="co">#&gt; 24: Guido0: Waited 1</span>
<span class="co">#&gt; 28.0923: Customer4: Queue is 2 on arrival</span>
<span class="co">#&gt; 36: Guido0: Completed</span>
<span class="co">#&gt; 36: Customer2: Waited 27.3589401547341</span>
<span class="co">#&gt; 48: Customer2: Completed</span>
<span class="co">#&gt; 48: Customer3: Waited 26.8654149797765</span>
<span class="co">#&gt; 60: Customer3: Completed</span>
<span class="co">#&gt; 60: Customer4: Waited 31.9076510670601</span>
<span class="co">#&gt; 72: Customer4: Completed</span>
<span class="co">#&gt; simmer environment: bank | now: 72 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
<span class="co">#&gt; { Generator: Guido | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0  0.0000000       12            12     TRUE           1</span>
<span class="co">#&gt; 2 Customer1  0.1773647       24            12     TRUE           1</span>
<span class="co">#&gt; 3    Guido0 23.0000000       36            12     TRUE           1</span>
<span class="co">#&gt; 4 Customer2  8.6410598       48            12     TRUE           1</span>
<span class="co">#&gt; 5 Customer3 21.1345850       60            12     TRUE           1</span>
<span class="co">#&gt; 6 Customer4 28.0923489       72            12     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1      0.00000</span>
<span class="co">#&gt; 2     11.82264</span>
<span class="co">#&gt; 3      1.00000</span>
<span class="co">#&gt; 4     27.35894</span>
<span class="co">#&gt; 5     26.86541</span>
<span class="co">#&gt; 6     31.90765</span></code></pre></div>
<p>The output above displays the number of customers in the queue just as each one arrives. That count does not include any customer in service.</p>
<p>Reading carefully one can see that when Guido arrives Customer0 has been served and left at 12, Customer1 is in service and two (customers 2 and 3) are queueing. Guido has priority over those waiting and is served before them at 24. When Guido leaves at 36, Customer2 starts service.</p>
</div>
<div id="priority-customers-with-preemption" class="section level3">
<h3 class="hasAnchor">
<a href="#priority-customers-with-preemption" class="anchor"></a>Priority customers with preemption</h3>
<p>Now we allow Guido to have preemptive priority. He will displace any customer in service when he arrives. That customer will resume when Guido finishes (unless higher priority customers intervene). It requires only a change to one line of the program, adding the argument, <code>preemptive = TRUE</code> to the <code>add_resource</code> function call.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1933</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {
         <span class="kw">paste</span>(<span class="st">"Queue is"</span>, <span class="kw"><a href="../reference/get_capacity.html">get_queue_count</a></span>(bank, <span class="st">"counter"</span>), <span class="st">"on arrival"</span>)
         }) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Completed"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>, <span class="dt">preemptive =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Guido"</span>, customer, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">23</span>), <span class="dt">priority =</span> <span class="dv">1</span>)

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Queue is 0 on arrival</span>
<span class="co">#&gt; 0: Customer0: Waited 0</span>
<span class="co">#&gt; 0.177365: Customer1: Queue is 0 on arrival</span>
<span class="co">#&gt; 8.64106: Customer2: Queue is 1 on arrival</span>
<span class="co">#&gt; 12: Customer0: Completed</span>
<span class="co">#&gt; 12: Customer1: Waited 11.8226352687925</span>
<span class="co">#&gt; 21.1346: Customer3: Queue is 1 on arrival</span>
<span class="co">#&gt; 23: Guido0: Queue is 2 on arrival</span>
<span class="co">#&gt; 23: Guido0: Waited 0</span>
<span class="co">#&gt; 28.0923: Customer4: Queue is 3 on arrival</span>
<span class="co">#&gt; 35: Guido0: Completed</span>
<span class="co">#&gt; 36: Customer1: Completed</span>
<span class="co">#&gt; 36: Customer2: Waited 27.3589401547341</span>
<span class="co">#&gt; 48: Customer2: Completed</span>
<span class="co">#&gt; 48: Customer3: Waited 26.8654149797765</span>
<span class="co">#&gt; 60: Customer3: Completed</span>
<span class="co">#&gt; 60: Customer4: Waited 31.9076510670601</span>
<span class="co">#&gt; 72: Customer4: Completed</span>
<span class="co">#&gt; simmer environment: bank | now: 72 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
<span class="co">#&gt; { Generator: Guido | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0  0.0000000       12            12     TRUE           1</span>
<span class="co">#&gt; 2    Guido0 23.0000000       35            12     TRUE           1</span>
<span class="co">#&gt; 3 Customer1  0.1773647       36            12     TRUE           1</span>
<span class="co">#&gt; 4 Customer2  8.6410598       48            12     TRUE           1</span>
<span class="co">#&gt; 5 Customer3 21.1345850       60            12     TRUE           1</span>
<span class="co">#&gt; 6 Customer4 28.0923489       72            12     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1      0.00000</span>
<span class="co">#&gt; 2      0.00000</span>
<span class="co">#&gt; 3     23.82264</span>
<span class="co">#&gt; 4     27.35894</span>
<span class="co">#&gt; 5     26.86541</span>
<span class="co">#&gt; 6     31.90765</span></code></pre></div>
<p>Though Guido arrives at the same time, 23, he no longer has to wait and immediately goes into service, displacing the incumbent, Customer1. That customer had already completed 23 - 12 = 11 minutes of his service. When Guido finishes at 35, Customer1 resumes service and takes 36 - 35 = 1 minutes to finish. His total service time is the same as before (12 minutes).</p>
</div>
</div>
<div id="balking-and-reneging-customers" class="section level2">
<h2 class="hasAnchor">
<a href="#balking-and-reneging-customers" class="anchor"></a>Balking and reneging customers</h2>
<p>Balking occurs when a customer refuses to join a queue if it is too long. Reneging (or, better, abandonment) occurs if an impatient customer gives up while still waiting and before being served.</p>
<div id="balking-customers" class="section level3">
<h3 class="hasAnchor">
<a href="#balking-customers" class="anchor"></a>Balking customers</h3>
<p>Another term for a system with balking customers is one where “blocked customers” are “cleared”, termed by engineers a BCC system. This is very convenient analytically in queueing theory and formulae developed using this assumption are used extensively for planning communication systems. The easiest case is when no queueing is allowed.</p>
<p>As an example let us investigate a BCC system with a single server but the waiting space is limited. We will estimate the rate of balking when the maximum number in the queue is set to 1. On arrival into the system the customer must first check to see if there is room. If there is not enough room, the customer balks.</p>
<p>To get the balking rate, we first count the number of arrivals that didn’t finish, using the data given by <code><a href="../reference/get_mon.html">get_mon_arrivals()</a></code>. Then we divide it by the current model time from <code><a href="../reference/now.html">now(bank)</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

timeInBank &lt;-<span class="st"> </span><span class="dv">12</span> <span class="co"># mean, minutes</span>
ARRint &lt;-<span class="st"> </span><span class="dv">10</span>     <span class="co"># mean, minutes</span>
numServers &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># servers</span>
maxInSystem &lt;-<span class="st"> </span><span class="dv">2</span> <span class="co"># customers</span>
maxInQueue &lt;-<span class="st"> </span>maxInSystem <span class="op">-</span><span class="st"> </span>numServers

maxNumber &lt;-<span class="st"> </span><span class="dv">8</span>
maxTime &lt;-<span class="st"> </span><span class="dv">400</span>  <span class="co"># minutes</span>
<span class="kw">set.seed</span>(<span class="dv">59098</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>,
        <span class="dt">continue =</span> <span class="ot">FALSE</span>,
        <span class="dt">reject =</span>
          <span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Balked customer"</span>) <span class="op">%&gt;%</span>
<span class="st">          </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"BALKING"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span>timeInBank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Finished"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>,
               <span class="dt">capacity =</span> numServers,
               <span class="dt">queue_size =</span> maxInQueue) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>,
                customer,
                <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(<span class="kw">rexp</span>(maxNumber <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>ARRint)))))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> maxTime)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 0: Customer0: Waited 0</span>
<span class="co">#&gt; 0.822239: Customer1: Here I am</span>
<span class="co">#&gt; 1.01227: Customer2: Here I am</span>
<span class="co">#&gt; 1.01227: Customer2: BALKING</span>
<span class="co">#&gt; 4.7448: Customer3: Here I am</span>
<span class="co">#&gt; 4.7448: Customer3: BALKING</span>
<span class="co">#&gt; 20.5472: Customer4: Here I am</span>
<span class="co">#&gt; 20.5472: Customer4: BALKING</span>
<span class="co">#&gt; 21.6132: Customer5: Here I am</span>
<span class="co">#&gt; 21.6132: Customer5: BALKING</span>
<span class="co">#&gt; 22.7358: Customer0: Finished</span>
<span class="co">#&gt; 22.7358: Customer1: Waited 21.9136007670654</span>
<span class="co">#&gt; 23.5339: Customer6: Here I am</span>
<span class="co">#&gt; 32.1107: Customer7: Here I am</span>
<span class="co">#&gt; 32.1107: Customer7: BALKING</span>
<span class="co">#&gt; 52.5108: Customer1: Finished</span>
<span class="co">#&gt; 52.5108: Customer6: Waited 28.9769820388615</span>
<span class="co">#&gt; 55.8923: Customer6: Finished</span>
<span class="co">#&gt; simmer environment: bank | now: 55.8923309646971 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(1) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 8 }</span>

number_balked &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="op">!</span><span class="kw"><a href="../reference/get_mon.html">get_mon_arrivals</a></span>(bank)<span class="op">$</span>finished)
<span class="kw">paste</span>(<span class="st">"Balking rate is"</span>, number_balked <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../reference/now.html">now</a></span>(bank), <span class="st">"customers per minute."</span>)
<span class="co">#&gt; [1] "Balking rate is 0 customers per minute."</span></code></pre></div>
<p>When Customer2 arrives, Customer0 is already in service and Customer1 is waiting. There is no room, so Customer2 balks. By the vagaries of exponential random numbers, Customer0 takes a very long time to serve (22.7358 minutes) so the first one to find room is number Customer6 at 25.5339.</p>
</div>
<div id="reneging-or-abandoning-customers" class="section level3">
<h3 class="hasAnchor">
<a href="#reneging-or-abandoning-customers" class="anchor"></a>Reneging (or abandoning) customers</h3>
<p>Often in practice an impatient customer will leave the queue before being served. Simmer can model this reneging behaviour using the <code><a href="../reference/renege_in.html">renege_in()</a></code> function in a trajectory. This defines the maximum time that a customer will wait before reneging, as well as an ‘out’ trajectory for them to follow when they renege.</p>
<p>If the customer reaches the server before reneging, then their impatience must be cancelled with the <code><a href="../reference/renege_in.html">renege_abort()</a></code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

timeInBank &lt;-<span class="st"> </span><span class="dv">15</span> <span class="co"># mean, minutes</span>
ARRint &lt;-<span class="st"> </span><span class="dv">10</span>     <span class="co"># mean, minutes</span>
numServers &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># servers</span>

maxNumber &lt;-<span class="st"> </span><span class="dv">5</span>
maxTime &lt;-<span class="st"> </span><span class="dv">400</span>   <span class="co"># minutes</span>
maxWaitTime &lt;-<span class="st"> </span><span class="dv">12</span> <span class="co"># minutes, maximum time to wait before reneging</span>
<span class="kw">set.seed</span>(<span class="dv">59030</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/renege_in.html">renege_in</a></span>(maxWaitTime,
            <span class="dt">out =</span> <span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Reneging customer"</span>) <span class="op">%&gt;%</span>
<span class="st">              </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {
                     <span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>), <span class="st">"I am off"</span>)
                   })) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/renege_in.html">renege_abort</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Stay if I'm being attended within maxWaitTime</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span>timeInBank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Completed"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>,
               <span class="dt">capacity =</span> numServers) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>,
                customer,
                <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(<span class="kw">rexp</span>(maxNumber <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>ARRint)))))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> maxTime)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 0: Customer0: Waited 0</span>
<span class="co">#&gt; 16.5058: Customer1: Here I am</span>
<span class="co">#&gt; 28.5058: Customer1: Waited 12 I am off</span>
<span class="co">#&gt; 34.339: Customer2: Here I am</span>
<span class="co">#&gt; 41.8687: Customer3: Here I am</span>
<span class="co">#&gt; 46.339: Customer2: Waited 12 I am off</span>
<span class="co">#&gt; 49.3671: Customer4: Here I am</span>
<span class="co">#&gt; 53.8687: Customer3: Waited 12 I am off</span>
<span class="co">#&gt; 54.7374: Customer0: Completed</span>
<span class="co">#&gt; 54.7374: Customer4: Waited 5.37030150208617</span>
<span class="co">#&gt; 64.6857: Customer4: Completed</span>
<span class="co">#&gt; simmer environment: bank | now: 64.6856688172597 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span></code></pre></div>
<p>Customer1 arrives after Customer0 but has only 12 minutes patience. After that time in the queue (at time 28.5058) he abandons the queue to leave Customer2 to take his place. Customer2 and Customer3 also renege. Customer4 is served within 12 minutes.</p>
</div>
</div>
<div id="interrupting-a-process" class="section level2">
<h2 class="hasAnchor">
<a href="#interrupting-a-process" class="anchor"></a>Interrupting a process</h2>
<p>Klaus goes into the bank to talk to the manager. For clarity we ignore the counters and other customers. During his conversation his cellphone rings. When he finishes the call he continues the conversation.</p>
<p>In this example, the call is another trajectory, whose only activities are to send a signal (the ringing of the phone), and to write that event to the log.</p>
<p>In Klaus’ trajectory, the <code>trap</code> activity causes him to listen for the phone to ring. Supposing the phone doesn’t ring, then his trajectory would continue to the <code>timeout</code> activity, where he would do his banking business for 20 minutes, and then finish.</p>
<p>Supposing the phone <em>does</em> ring, then Klaus would enter the sub-trajectory defined within the <code>trap</code> function as a ‘handler’. In that trajectory, he makes his excuses, answers the phone, then returns to business. At the end of the trajectory, he continues the original trajectory at the next step <em>following</em> the original <code>timeout</code>, without spending the rest of the 20 minutes on his banking.</p>
<p>To make Klaus spend a full 20 minutes banking, we add a <code>timeout</code> activity to the end of the ‘handler’, but first we have to calculate how much time remains after the interruption. This is done by storing the ‘start’ time in an attribute, and calculating how much time is left when the phone rings.</p>
<p>By default, interruptions can themselves be interrupted, as illustrated in this example by the phone ringing twice. This could be avoided by setting <code>interruptible = FALSE</code> in the <code>trap</code> activity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

timeInBank &lt;-<span class="st">  </span><span class="dv">20</span>
timeOfCall &lt;-<span class="st">   </span><span class="dv">9</span>
onphone    &lt;-<span class="st">   </span><span class="dv">3</span>
maxTime    &lt;-<span class="st"> </span><span class="dv">100</span>

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/send.html">trap</a></span>(<span class="st">"phonecall"</span>,
       <span class="dt">handler =</span> <span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>() <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Excuse me"</span>) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(
           <span class="st">"timeleft"</span>, <span class="cf">function</span>() {
             <span class="kw">sum</span>(<span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="kw">c</span>(<span class="st">"timeleft"</span>, <span class="st">"start"</span>))) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/now.html">now</a></span>(bank)
         }) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Hello! I'll call back"</span>) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(onphone) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Sorry, where were we?"</span>) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Time left:"</span>, <span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"timeleft"</span>))}) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"timeleft"</span>)})
       ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"timeleft"</span>, timeInBank) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(timeInBank) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Completed"</span>)

phone &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Phone"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Ringgg!"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/send.html">send</a></span>(<span class="st">"phonecall"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Klaus"</span>, customer, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Phone"</span>, phone, <span class="kw"><a href="../reference/at.html">at</a></span>(timeOfCall, timeOfCall <span class="op">+</span><span class="st"> </span><span class="dv">7</span>))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> maxTime)
<span class="co">#&gt; 0: Klaus0: Here I am</span>
<span class="co">#&gt; 9: Phone0: Ringgg!</span>
<span class="co">#&gt; 9: Klaus0: Excuse me</span>
<span class="co">#&gt; 9: Klaus0: Hello! I'll call back</span>
<span class="co">#&gt; 12: Klaus0: Sorry, where were we?</span>
<span class="co">#&gt; 12: Klaus0: Time left: 11</span>
<span class="co">#&gt; 16: Phone1: Ringgg!</span>
<span class="co">#&gt; 16: Klaus0: Excuse me</span>
<span class="co">#&gt; 16: Klaus0: Hello! I'll call back</span>
<span class="co">#&gt; 19: Klaus0: Sorry, where were we?</span>
<span class="co">#&gt; 19: Klaus0: Time left: 7</span>
<span class="co">#&gt; 26: Klaus0: Completed</span>
<span class="co">#&gt; simmer environment: bank | now: 26 | next: </span>
<span class="co">#&gt; { Generator: Klaus | monitored: 1 | n_generated: 1 }</span>
<span class="co">#&gt; { Generator: Phone | monitored: 1 | n_generated: 2 }</span></code></pre></div>
<p>As this has no random numbers the results are reasonably clear: the first interrupting call occurs at 9. It takes Klaus 3 minutes to listen to the message and he resumes the conversation with the bank manager at 12. The phone rings again at 16, he listens for three more minutes, and resumes the conversation at 19, finally finishing at 26. The total time of conversation is 9 + 4 + 7 = 20 minutes, the same as it would have been if the interrupt had not occurred.</p>
</div>
<div id="wait-until-the-bank-door-opens" class="section level2">
<h2 class="hasAnchor">
<a href="#wait-until-the-bank-door-opens" class="anchor"></a>Wait until the bank door opens</h2>
<p>Customers arrive at random, some of them getting to the bank before the door is opened by a doorman. They wait for the door to be opened and then rush in and queue to be served.</p>
<p>This model defines the door as a resource, just like the counter. The capacity of the door is defined according to the <code>schedule</code> function, so that it has zero capacity when it is shut, and infinite capacity when it is open. Customers ‘seize’ the door and must then wait until it has capacity to ‘serve’ them. Once it is available, all waiting customers are ‘served’ immediately (i.e. they pass through the door). There is no <code>timeout</code> between ‘seizing’ and ‘releasing’ the door.</p>
<p>For the sake of announcing in the log that the door has been opened, a doorman trajectory is defined.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

maxTime =<span class="st"> </span><span class="dv">400</span>
<span class="kw">set.seed</span>(<span class="dv">393937</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {
         capacity &lt;-
<span class="st">           </span><span class="kw"><a href="../reference/get_mon.html">get_mon_resources</a></span>(bank) <span class="op">%&gt;%</span>
<span class="st">           </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/filter">filter</a></span>(resource <span class="op">==</span><span class="st"> "door"</span>) <span class="op">%&gt;%</span>
<span class="st">           </span>.<span class="op">$</span>capacity
         <span class="cf">if</span> (<span class="kw">length</span>(capacity) <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">||</span><span class="st"> </span><span class="kw">tail</span>(capacity, <span class="dv">1</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
           <span class="kw">return</span>(<span class="st">"Here I am but the door is shut."</span>)
         }
         <span class="st">"Here I am and the door is open."</span>
       }) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"door"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"I can go in!"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"door"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>)

openTime &lt;-<span class="st"> </span><span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>)

door_schedule &lt;-<span class="st"> </span><span class="kw"><a href="../reference/schedule.html">schedule</a></span>(<span class="kw">c</span>(<span class="dv">0</span>, openTime), <span class="kw">c</span>(<span class="dv">0</span>, <span class="ot">Inf</span>))

doorman &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(openTime) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Ladies and Gentlemen! You may all enter."</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"door"</span>, <span class="dt">capacity =</span> door_schedule) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>,
                customer,
                <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(<span class="kw">rexp</span>(<span class="dv">5</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="fl">0.1</span>))))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Doorman"</span>, doorman, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">0</span>))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> maxTime)
<span class="co">#&gt; 0: Customer0: Here I am but the door is shut.</span>
<span class="co">#&gt; 6.44076: Customer1: Here I am but the door is shut.</span>
<span class="co">#&gt; 8.77564: Customer2: Here I am but the door is shut.</span>
<span class="co">#&gt; 19.7241: Doorman0: Ladies and Gentlemen! You may all enter.</span>
<span class="co">#&gt; 19.7241: Customer0: I can go in!</span>
<span class="co">#&gt; 19.7241: Customer1: I can go in!</span>
<span class="co">#&gt; 19.7241: Customer2: I can go in!</span>
<span class="co">#&gt; 24.2037: Customer3: Here I am and the door is open.</span>
<span class="co">#&gt; 24.2037: Customer3: I can go in!</span>
<span class="co">#&gt; 33.3576: Customer4: Here I am and the door is open.</span>
<span class="co">#&gt; 33.3576: Customer4: I can go in!</span>
<span class="co">#&gt; simmer environment: bank | now: 79.2542060826083 | next: </span>
<span class="co">#&gt; { Resource: door | monitored: TRUE | server status: 0(Inf) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
<span class="co">#&gt; { Generator: Doorman | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1  Doorman0   0.000000 19.72408     19.724085     TRUE           1</span>
<span class="co">#&gt; 2 Customer0   0.000000 46.61084     26.886751     TRUE           1</span>
<span class="co">#&gt; 3 Customer1   6.440758 64.20811     17.597279     TRUE           1</span>
<span class="co">#&gt; 4 Customer2   8.775635 71.50006      7.291950     TRUE           1</span>
<span class="co">#&gt; 5 Customer3  24.203687 73.96270      2.462632     TRUE           1</span>
<span class="co">#&gt; 6 Customer4  33.357600 79.25421      5.291510     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1      0.00000</span>
<span class="co">#&gt; 2     19.72408</span>
<span class="co">#&gt; 3     40.17008</span>
<span class="co">#&gt; 4     55.43248</span>
<span class="co">#&gt; 5     47.29638</span>
<span class="co">#&gt; 6     40.60510</span></code></pre></div>
<p>The output above programs shows how the first two customers have to wait until the door is opened.</p>
</div>
<div id="wait-for-the-doorman-to-give-a-signal" class="section level1">
<h1 class="hasAnchor">
<a href="#wait-for-the-doorman-to-give-a-signal" class="anchor"></a>Wait for the doorman to give a signal</h1>
<p>Customers arrive at random, some of them getting to the bank before the door is open. This is controlled by an automatic machine called the doorman which opens the door only at intervals of 30 minutes (it is a very secure bank). The customers wait for the door to be opened and all those waiting enter and proceed to the counter. The door is closed behind them.</p>
<p>There are at least two ways to implement this model. The first example uses a schedule, and the second uses batching.</p>
<p>The principle behind the schedule is that the door is modelled as a server with zero capacity for 30 minutes, then infinite capacity for zero minutes, then repeat the 30-minute cycle. In the moment that it has infinite capacity, all the customers will pass through the door (i.e. they will be ‘served’).</p>
<p>For the sake of announcing in the log that the door has been opened, a doorman trajectory is defined. The doorman has a <code>rollback</code> step so that it keeps opening and shutting the door every 30 minutes for ever.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

maxTime =<span class="st"> </span><span class="dv">150</span>

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am, but the door is shut."</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"door"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"The door is open!"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"door"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Finished."</span>)

door_schedule &lt;-<span class="st"> </span><span class="kw"><a href="../reference/schedule.html">schedule</a></span>(<span class="kw">c</span>(<span class="dv">30</span>, <span class="dv">30</span>), <span class="kw">c</span>(<span class="ot">Inf</span>, <span class="dv">0</span>), <span class="dt">period =</span> <span class="dv">30</span>)

doorman &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Doorman"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">30</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"You may enter."</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/rollback.html">rollback</a></span>(<span class="dv">2</span>, <span class="dt">times =</span> <span class="ot">Inf</span>)

<span class="kw">set.seed</span>(<span class="dv">393939</span>)
bank &lt;-<span class="st"> </span><span class="kw">simmer</span>(<span class="st">"bank"</span>)
bank <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"door"</span>, <span class="dt">capacity =</span> door_schedule) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>,
                customer,
                <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(<span class="kw">rexp</span>(<span class="dv">5</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="fl">0.1</span>))))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Doorman"</span>, doorman, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">0</span>))
<span class="co">#&gt; simmer environment: bank | now: 0 | next: 0</span>
<span class="co">#&gt; { Resource: door | monitored: TRUE | server status: 0(0) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 0 }</span>
<span class="co">#&gt; { Generator: Doorman | monitored: 1 | n_generated: 0 }</span>

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> maxTime)
<span class="co">#&gt; 0: Customer0: Here I am, but the door is shut.</span>
<span class="co">#&gt; 25.4605: Customer1: Here I am, but the door is shut.</span>
<span class="co">#&gt; 30: Doorman0: You may enter.</span>
<span class="co">#&gt; 30: Customer0: The door is open!</span>
<span class="co">#&gt; 30: Customer0: Waited 30</span>
<span class="co">#&gt; 30: Customer1: The door is open!</span>
<span class="co">#&gt; 30: Customer1: Waited 4.53951782839885</span>
<span class="co">#&gt; 35.4334: Customer2: Here I am, but the door is shut.</span>
<span class="co">#&gt; 36.0565: Customer0: Finished.</span>
<span class="co">#&gt; 40.6413: Customer3: Here I am, but the door is shut.</span>
<span class="co">#&gt; 48.7442: Customer1: Finished.</span>
<span class="co">#&gt; 49.063: Customer4: Here I am, but the door is shut.</span>
<span class="co">#&gt; 60: Doorman0: You may enter.</span>
<span class="co">#&gt; 60: Customer2: The door is open!</span>
<span class="co">#&gt; 60: Customer2: Waited 24.566617201638</span>
<span class="co">#&gt; 60: Customer3: The door is open!</span>
<span class="co">#&gt; 60: Customer3: Waited 19.3586741095377</span>
<span class="co">#&gt; 60: Customer4: The door is open!</span>
<span class="co">#&gt; 60: Customer4: Waited 10.9369934153668</span>
<span class="co">#&gt; 66.7763: Customer2: Finished.</span>
<span class="co">#&gt; 71.3982: Customer3: Finished.</span>
<span class="co">#&gt; 79.5795: Customer4: Finished.</span>
<span class="co">#&gt; 90: Doorman0: You may enter.</span>
<span class="co">#&gt; 120: Doorman0: You may enter.</span>
<span class="co">#&gt; simmer environment: bank | now: 150 | next: 150</span>
<span class="co">#&gt; { Resource: door | monitored: TRUE | server status: 0(0) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
<span class="co">#&gt; { Generator: Doorman | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0    0.00000 36.05646      6.056458     TRUE           1</span>
<span class="co">#&gt; 2 Customer1   25.46048 48.74417     12.687713     TRUE           1</span>
<span class="co">#&gt; 3 Customer2   35.43338 66.77625      6.776253     TRUE           1</span>
<span class="co">#&gt; 4 Customer3   40.64133 71.39816      4.621910     TRUE           1</span>
<span class="co">#&gt; 5 Customer4   49.06301 79.57954      8.181380     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1     30.00000</span>
<span class="co">#&gt; 2     10.59598</span>
<span class="co">#&gt; 3     24.56662</span>
<span class="co">#&gt; 4     26.13493</span>
<span class="co">#&gt; 5     22.33516</span></code></pre></div>
<p>The output run for this program shows how the first two customers have to wait until the door is opened, and then the next three have to wait.</p>
<p>The second method is batching. Customers can be collected into batches of a given size, or for a given time, or whichever occurs first. Here, they are collected for periods of 30, and the number of customers in each batch is unrestricted.</p>
<p>After the batch is created with <code>batch</code>, usually the customers will all be processed together by a server, before separating with <code>separate</code>. In this example, there is no need for a server – the door is modelled by the batch itself – so the customers are separated immediately after the batch.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

maxTime =<span class="st"> </span><span class="dv">150</span>

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am, but the door is shut."</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/batch.html">batch</a></span>(<span class="dt">n =</span> <span class="ot">Inf</span>, <span class="dt">timeout =</span> <span class="dv">30</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/batch.html">separate</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"The door is open!"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Finished."</span>)

doorman &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Doorman"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">30</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"You may enter."</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/rollback.html">rollback</a></span>(<span class="dv">2</span>, <span class="dt">times =</span> <span class="ot">Inf</span>)

<span class="kw">set.seed</span>(<span class="dv">393939</span>)
bank &lt;-<span class="st"> </span><span class="kw">simmer</span>(<span class="st">"bank"</span>)
bank <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"door"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>,
                customer,
                <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(<span class="kw">rexp</span>(<span class="dv">5</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="fl">0.1</span>))))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Doorman"</span>, doorman, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">0</span>))
<span class="co">#&gt; simmer environment: bank | now: 0 | next: 0</span>
<span class="co">#&gt; { Resource: door | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 0 }</span>
<span class="co">#&gt; { Generator: Doorman | monitored: 1 | n_generated: 0 }</span>

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> maxTime)
<span class="co">#&gt; 0: Customer0: Here I am, but the door is shut.</span>
<span class="co">#&gt; 25.4605: Customer1: Here I am, but the door is shut.</span>
<span class="co">#&gt; 30: Doorman0: You may enter.</span>
<span class="co">#&gt; 30: Customer0: The door is open!</span>
<span class="co">#&gt; 30: Customer0: Waited 30</span>
<span class="co">#&gt; 30: Customer1: The door is open!</span>
<span class="co">#&gt; 30: Customer1: Waited 4.53951782839885</span>
<span class="co">#&gt; 35.4334: Customer2: Here I am, but the door is shut.</span>
<span class="co">#&gt; 36.0565: Customer0: Finished.</span>
<span class="co">#&gt; 40.6413: Customer3: Here I am, but the door is shut.</span>
<span class="co">#&gt; 48.7442: Customer1: Finished.</span>
<span class="co">#&gt; 49.063: Customer4: Here I am, but the door is shut.</span>
<span class="co">#&gt; 60: Doorman0: You may enter.</span>
<span class="co">#&gt; 60: Customer2: The door is open!</span>
<span class="co">#&gt; 60: Customer2: Waited 24.566617201638</span>
<span class="co">#&gt; 60: Customer3: The door is open!</span>
<span class="co">#&gt; 60: Customer3: Waited 19.3586741095377</span>
<span class="co">#&gt; 60: Customer4: The door is open!</span>
<span class="co">#&gt; 60: Customer4: Waited 10.9369934153668</span>
<span class="co">#&gt; 66.7763: Customer2: Finished.</span>
<span class="co">#&gt; 71.3982: Customer3: Finished.</span>
<span class="co">#&gt; 79.5795: Customer4: Finished.</span>
<span class="co">#&gt; 90: Doorman0: You may enter.</span>
<span class="co">#&gt; 120: Doorman0: You may enter.</span>
<span class="co">#&gt; simmer environment: bank | now: 150 | next: 150</span>
<span class="co">#&gt; { Resource: door | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
<span class="co">#&gt; { Generator: Doorman | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0    0.00000 36.05646      6.056458     TRUE           1</span>
<span class="co">#&gt; 2 Customer1   25.46048 48.74417     12.687713     TRUE           1</span>
<span class="co">#&gt; 3 Customer2   35.43338 66.77625      6.776253     TRUE           1</span>
<span class="co">#&gt; 4 Customer3   40.64133 71.39816      4.621910     TRUE           1</span>
<span class="co">#&gt; 5 Customer4   49.06301 79.57954      8.181380     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1     30.00000</span>
<span class="co">#&gt; 2     10.59598</span>
<span class="co">#&gt; 3     24.56662</span>
<span class="co">#&gt; 4     26.13493</span>
<span class="co">#&gt; 5     22.33516</span></code></pre></div>
<p>This second method gives the same output as the first.</p>
<div id="monitors" class="section level2">
<h2 class="hasAnchor">
<a href="#monitors" class="anchor"></a>Monitors</h2>
<p>Monitors record events in a simulation. Unlike SimPy, Simmer does this by default, so the records are available after – in fact, even during – a simulation. Data that is collected by monitors is available from the following functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">get_capacity
get_mon_arrivals
get_mon_attributes
get_mon_resources
get_n_activities
get_n_generated
get_queue_count
get_queue_size
get_server_count</code></pre></div>
<p>The <code>get_mon_*()</code> functions return a data frame (which is growing during the simulation, so that, although possible, it is computationally expensive to call them from inside a trajectory). The others return a numeric value.</p>
<div id="plotting-a-histogram-of-monitor-results" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-a-histogram-of-monitor-results" class="anchor"></a>Plotting a histogram of monitor results</h3>
<p>A histogram of the amount of time that customers spend in the bank can be plotted by taking some basic information – start and end time of each customer – from the <code><a href="../reference/get_mon.html">get_mon_arrivals()</a></code> function, and then calculating the elapsed time. This example draws the plot with the <code>ggplot2</code> package, but other plotting packages, and base R graphics, could do something similar.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)
<span class="kw">library</span>(simmer.plot)
<span class="co">#&gt; Loading required package: ggplot2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'simmer.plot'</span>
<span class="co">#&gt; The following objects are masked from 'package:simmer':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     get_mon_arrivals, get_mon_attributes, get_mon_resources</span>
<span class="co"># library(ggplot2) # (automatically loaded with simmer.plot)</span>

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>)

<span class="kw">set.seed</span>(<span class="dv">393939</span>)
bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>,
                customer,
                <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">cumsum</span>(<span class="kw">rexp</span>(<span class="dv">20</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="fl">0.1</span>)))))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dv">400</span>)
<span class="co">#&gt; simmer environment: bank | now: 253.460482171601 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 20 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(end_time <span class="op">-</span><span class="st"> </span>start_time)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_histogram</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">"Time spent in the system"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">"Number of customers"</span>)
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="simmer-04-bank-2_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="monitoring-a-resource" class="section level3">
<h3 class="hasAnchor">
<a href="#monitoring-a-resource" class="anchor"></a>Monitoring a resource</h3>
<p>Now consider observing the number of customers waiting or active in a Resource.</p>
<p><code><a href="../reference/get_mon.html">get_mon_resources()</a></code> returns a table of states and times for the counter. Whenever a customer enters/leaves a queue/counter, a new row is created recording the number of customers in the queue, the counter and the system as a whole. We call this the ‘state’. The amount of time that the state lasts is the difference in time between one state and the next, which we calculate with the <code>diff()</code> function. Finally, we multiply the number of customers in each state by the duration of the state, and divide by the duration of the simulation (the time at the end) to get the average.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1234</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Arrived"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Got counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited"</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Finished"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Arrived</span>
<span class="co">#&gt; 0: Customer0: Got counter</span>
<span class="co">#&gt; 0: Customer0: Waited 0</span>
<span class="co">#&gt; 12: Customer0: Finished</span>
<span class="co">#&gt; 25.0176: Customer1: Arrived</span>
<span class="co">#&gt; 25.0176: Customer1: Got counter</span>
<span class="co">#&gt; 25.0176: Customer1: Waited 0</span>
<span class="co">#&gt; 27.4852: Customer2: Arrived</span>
<span class="co">#&gt; 27.551: Customer3: Arrived</span>
<span class="co">#&gt; 37.0176: Customer1: Finished</span>
<span class="co">#&gt; 37.0176: Customer2: Got counter</span>
<span class="co">#&gt; 37.0176: Customer2: Waited 9.53241116646677</span>
<span class="co">#&gt; 44.9785: Customer4: Arrived</span>
<span class="co">#&gt; 49.0176: Customer2: Finished</span>
<span class="co">#&gt; 49.0176: Customer3: Got counter</span>
<span class="co">#&gt; 49.0176: Customer3: Waited 21.466591599012</span>
<span class="co">#&gt; 61.0176: Customer3: Finished</span>
<span class="co">#&gt; 61.0176: Customer4: Got counter</span>
<span class="co">#&gt; 61.0176: Customer4: Waited 16.0391307005949</span>
<span class="co">#&gt; 73.0176: Customer4: Finished</span>
<span class="co">#&gt; simmer environment: bank | now: 73.0175860496223 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
customer_monitor &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/get_mon.html">get_mon_arrivals</a></span>(bank) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">wait =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
mean_waiting_time &lt;-<span class="st"> </span><span class="kw">mean</span>(customer_monitor<span class="op">$</span>wait)

resource_monitor &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_mon.html">get_mon_resources</a></span>(bank)

queue_state &lt;-<span class="st"> </span><span class="kw">head</span>(resource_monitor<span class="op">$</span>queue, <span class="op">-</span><span class="dv">1</span>)
server_state &lt;-<span class="st"> </span><span class="kw">head</span>(resource_monitor<span class="op">$</span>server, <span class="op">-</span><span class="dv">1</span>)

time_state_lasted &lt;-<span class="st"> </span><span class="kw">diff</span>(resource_monitor<span class="op">$</span>time)
time_at_end &lt;-<span class="st"> </span><span class="kw">max</span>(resource_monitor<span class="op">$</span>time)

mean_active_customers &lt;-<span class="st"> </span><span class="kw">sum</span>(server_state <span class="op">*</span><span class="st"> </span>time_state_lasted) <span class="op">/</span><span class="st"> </span>time_at_end
mean_waiting_customers &lt;-<span class="st"> </span><span class="kw">sum</span>(queue_state <span class="op">*</span><span class="st"> </span>time_state_lasted) <span class="op">/</span><span class="st"> </span>time_at_end

<span class="kw">cat</span>(<span class="st">" Average waiting = "</span>, mean_waiting_customers, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,
    <span class="st">"Average active  = "</span>, mean_active_customers, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)
<span class="co">#&gt;  Average waiting =  0.6442028 </span>
<span class="co">#&gt;  Average active  =  0.8217199</span></code></pre></div>
</div>
<div id="plotting-from-resource-monitors" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-from-resource-monitors" class="anchor"></a>Plotting from resource monitors</h3>
<p>All the <code>get_mon_*()</code> return information that enables us to graph the output. Alternative plotting packages can be used; here we use the <code>simmer.plot</code> package just to graph the number of customers waiting for the counter.</p>
<p>The <code>simmer.plot</code> package is imported at line 2. The function <code><a href="../reference/get_mon.html">get_mon_resources()</a></code> is not called because the function <code>plot()</code> calles <code><a href="../reference/get_mon.html">get_mon_resources()</a></code> itself. The <code>plot()</code> function has arguments to specifiy what to plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)
<span class="kw">library</span>(simmer.plot)

timeInBank &lt;-<span class="st"> </span><span class="dv">12</span> <span class="co"># mean, minutes</span>

<span class="kw">set.seed</span>(<span class="dv">1234</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span>timeInBank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">19</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; simmer environment: bank | now: 248.706140163915 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 20 }</span>

<span class="kw">plot</span>(bank,
     <span class="dt">what =</span> <span class="st">"resources"</span>,
     <span class="dt">metric =</span> <span class="st">"usage"</span>,
     <span class="dt">names =</span> <span class="st">"counter"</span>,
     <span class="dt">items =</span> <span class="st">"system"</span>,
     <span class="dt">steps =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Warning: 'plot.simmer' is deprecated.</span>
<span class="co">#&gt; Use 'plot(get_mon_resources(x))' instead.</span>
<span class="co">#&gt; See help("Deprecated")</span></code></pre></div>
<p><img src="simmer-04-bank-2_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#priority-customers">Priority customers</a></li>
      <li><a href="#balking-and-reneging-customers">Balking and reneging customers</a></li>
      <li><a href="#interrupting-a-process">Interrupting a process</a></li>
      <li><a href="#wait-until-the-bank-door-opens">Wait until the bank door opens</a></li>
      <li>
<a href="#wait-for-the-doorman-to-give-a-signal">Wait for the doorman to give a signal</a><ul class="nav nav-pills nav-stacked">
<li><a href="#monitors">Monitors</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Iñaki Ucar, Bart Smeets.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
