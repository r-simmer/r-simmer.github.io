<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Bank Tutorial: Part I • simmer</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">simmer | DES for R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-gears"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-graduation-cap"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/simmer-01-introduction.html">Introduction to simmer</a>
    </li>
    <li>
      <a href="../articles/simmer-02-terminology.html">Terminology</a>
    </li>
    <li>
      <a href="../articles/simmer-03-trajectories.html">Advanced Trajectory Usage</a>
    </li>
    <li>
      <a href="../articles/simmer-04-bank-1.html">The Bank Tutorial: Part I</a>
    </li>
    <li>
      <a href="../articles/simmer-04-bank-2.html">The Bank Tutorial: Part II</a>
    </li>
    <li>
      <a href="../articles/simmer-05-simpy.html">Other SimPy Examples</a>
    </li>
    <li>
      <a href="../articles/simmer-06-queueing.html">Queueing Systems</a>
    </li>
    <li>
      <a href="../articles/simmer-07-ctmc.html">Continuous-Time Markov Chains</a>
    </li>
    <li>
      <a href="../articles/simmer-08-philosophers.html">Dining Philosophers Problem</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-puzzle-piece"></span>
     
    Extensions
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../extensions/plot">simmer.plot</a>
    </li>
    <li>
      <a href="http://r-simmer.org/extensions/bricks">simmer.bricks</a>
    </li>
    <li>
      <a href="https://github.com/r-simmer/simmer.optim">simmer.optim</a>
    </li>
    <li>
      <a href="https://github.com/r-simmer/simmer.json">simmer.json</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-simmer/simmer">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>The Bank Tutorial: Part I</h1>
                        <h4 class="author">Duncan Garmonsway</h4>
            
            <h4 class="date">2018-01-04</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This tutorial is adapted from a tutorial for the Python 2 package ‘SimPy’, <a href="https://pythonhosted.org/SimPy/Tutorials/TheBank.html">here</a>. Users familiar with SimPy may find this tutorial helpful for transitioning to simmer. Some very basic material is not covered. Beginners should first read the vignettes <a href="simmer-01-introduction.html"><em>Introduction to simmer</em></a>, <a href="simmer-02-terminology.html"><em>Terminology</em></a> and <a href="simmer-03-trajectories.html"><em>Advanced Trajectory Usage</em></a>.</p>
</div>
<div id="a-single-customer" class="section level2">
<h2 class="hasAnchor">
<a href="#a-single-customer" class="anchor"></a>A single customer</h2>
<p>In this tutorial we model a simple bank with customers arriving at random. We develop the model step-by-step, starting out simply, and producing a running program at each stage.</p>
<p>A simulation should always be developed to answer a specific question; in these models we investigate how changing the number of bank servers or tellers might affect the waiting time for customers.</p>
<div id="a-customer-arriving-at-a-fixed-time" class="section level3">
<h3 class="hasAnchor">
<a href="#a-customer-arriving-at-a-fixed-time" class="anchor"></a>A customer arriving at a fixed time</h3>
<p>We first model a single customer who arrives at the bank for a visit, looks around at the decor for a time and then leaves. There is no queueing. First we will assume his arrival time and the time he spends in the bank are fixed.</p>
<p>The arrival time is fixed at 5, and the time spent in the bank is fixed at 10. We interpret ‘5’ and ‘10’ as ‘5 minutes’ and ‘10 minutes’. The simulation runs for a maximum of 100 minutes, or until all the customers that are generated complete their trajectories.</p>
<p>Note where these constants appear in the code below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"I must leave"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">5</span>))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">100</span>)
<span class="co">#&gt; 5: Customer0: Here I am</span>
<span class="co">#&gt; 15: Customer0: I must leave</span>
<span class="co">#&gt; simmer environment: bank | now: 15 | next: </span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span><span class="st"> </span>get_mon_arrivals
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0          5       15            10     TRUE           1</span></code></pre></div>
<p>The short trace printed out by the <code>get_mon_arrivals</code> function shows the result. The program finishes at simulation time 15 because there are no further events to be executed. At the end of the visit, the customer has no more actions and no other objects or customers are active.</p>
</div>
<div id="a-customer-arriving-at-random" class="section level3">
<h3 class="hasAnchor">
<a href="#a-customer-arriving-at-random" class="anchor"></a>A customer arriving at random</h3>
<p>Now we extend the model to allow our customer to arrive at a random simulated time though we will keep the time in the bank at 10, as before.</p>
<p>The change occurs in the arguments to the <code>add_generator</code> function. The function <code>rexp</code> draws from an exponential distribution with the given parameter, which in this case is <code>1/5</code>. See <code>?rexp</code> for more details. We also seed the random number generator with 10211 so that the same sequence of random numbers will be drawn every time the script is run.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">10212</span>)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"I must leave"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">5</span>)))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">100</span>)
<span class="co">#&gt; 7.8393: Customer0: Here I am</span>
<span class="co">#&gt; 17.8393: Customer0: I must leave</span>
<span class="co">#&gt; simmer environment: bank | now: 17.8393046225526 | next: </span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span><span class="st"> </span>get_mon_arrivals
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0   7.839305  17.8393            10     TRUE           1</span></code></pre></div>
<p>The trace shows that the customer now arrives at time 7.839305. Changing the seed value would change that time.</p>
</div>
<div id="more-customers" class="section level3">
<h3 class="hasAnchor">
<a href="#more-customers" class="anchor"></a>More customers</h3>
<p>Our simulation does little so far. To consider a simulation with several customers we return to the simple deterministic model and add more customers.</p>
<p>The program is almost as easy as the first example (A customer arriving at a fixed time). The main change is in the <code>add_generator</code> function, where we generate three customers by defining three start times. We also increase the maximum simulation time to 400 in the <code>run</code> function. Observe that we need only one definition of the customer trajectory, and generate several customers who follow that trajectory. These customers act quite independently in this model.</p>
<p>Each customer also stays in the bank for a different, but non-random, amount of time. This is an unusual case, so it requires an unusual bit of R code. The <code>timeout</code> function accepts either a constant waiting time, or a function that is called once per customer and returns a single value (e.g. <code>rexp(1, 1/10)</code>). So we need to create a function that returns a different, but specific, value each time it is called. We define a function called <code>loop</code> to do this. The <code>loop</code> function returns another function. In the example, we store that function under the name <code>x</code>. When called, the function <code>x</code> returns one of (in the example) 7, 10, and 20, in sequence, wrapping around when it is called a fourth time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Function to specify a series of waiting times, that loop around</span>
loop &lt;-<span class="st"> </span><span class="cf">function</span>(...) {
    time_diffs &lt;-<span class="st"> </span><span class="kw">c</span>(...)
    i &lt;-<span class="st"> </span><span class="dv">0</span>
    <span class="cf">function</span>() {
      <span class="cf">if</span> (i <span class="op">&lt;</span><span class="st"> </span><span class="kw">length</span>(time_diffs)) {
        i &lt;&lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span>
      } <span class="cf">else</span> {
        i &lt;&lt;-<span class="st"> </span><span class="dv">1</span>
      }
      <span class="kw">return</span>(time_diffs[i])
    }
  }

x &lt;-<span class="st"> </span><span class="kw">loop</span>(<span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">20</span>)
<span class="kw">x</span>(); <span class="kw">x</span>(); <span class="kw">x</span>(); <span class="kw">x</span>(); <span class="kw">x</span>()
<span class="co">#&gt; [1] 10</span>
<span class="co">#&gt; [1] 7</span>
<span class="co">#&gt; [1] 20</span>
<span class="co">#&gt; [1] 10</span>
<span class="co">#&gt; [1] 7</span></code></pre></div>
<p>The technical term for the <code>loop</code> function is a ‘closure’. How closures work is beyond the scope of this vignette; if you wish to learn more, then <a href="http://adv-r.had.co.nz/Functional-programming.html#closures">Advanced R</a> by Hadley Wickam has a good explanation.</p>
<p>When we use <code>loop</code> in the <code>timeout</code> function, we don’t need to assign its output to a name; it can be an ‘anonymous’ function. It will be called whenever a customer is about to wait and needs to know how long to wait for. Because only three customers are generated, and their first step is the timeout step, they are assigned 7, 10, and 20 in order.</p>
<p>Note that this code differs from the SimPy in the order that customers are defined. Here, the first customer to be defined is the one who arrives at 2 and waits for 7. That is because the arguments to <code><a href="../reference/at.html">at()</a></code> must be in ascending order.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="co"># Function to specify a series of waiting times in a loop</span>
loop &lt;-<span class="st"> </span><span class="cf">function</span>(...) {
    time_diffs &lt;-<span class="st"> </span><span class="kw">c</span>(...)
    i &lt;-<span class="st"> </span><span class="dv">0</span>
    <span class="cf">function</span>() {
      <span class="cf">if</span> (i <span class="op">&lt;</span><span class="st"> </span><span class="kw">length</span>(time_diffs)) {
        i &lt;&lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span>
      } <span class="cf">else</span> {
        i &lt;&lt;-<span class="st"> </span><span class="dv">1</span>
      }
      <span class="kw">return</span>(time_diffs[i])
    }
  }

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="kw">loop</span>(<span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">20</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"I must leave"</span>)


bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">12</span>))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 2: Customer0: Here I am</span>
<span class="co">#&gt; 5: Customer1: Here I am</span>
<span class="co">#&gt; 9: Customer0: I must leave</span>
<span class="co">#&gt; 12: Customer2: Here I am</span>
<span class="co">#&gt; 15: Customer1: I must leave</span>
<span class="co">#&gt; 32: Customer2: I must leave</span>
<span class="co">#&gt; simmer environment: bank | now: 32 | next: </span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 3 }</span>
bank <span class="op">%&gt;%</span><span class="st"> </span>get_mon_arrivals
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0          2        9             7     TRUE           1</span>
<span class="co">#&gt; 2 Customer1          5       15            10     TRUE           1</span>
<span class="co">#&gt; 3 Customer2         12       32            20     TRUE           1</span></code></pre></div>
<p>Alternatively, we can create three different customer trajectories for the three waiting times. This is best done by creating an initial template, and then modifying the waiting time for each copy.</p>
<p>Note that the order in which the customers are defined does not matter this time, and we can also name each customer.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="co"># Create a template trajectory</span>
customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># The timeout of 1 is a placeholder to be overwritten later</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"I must leave"</span>)

<span class="co"># Create three copies of the template</span>
Klaus &lt;-<span class="st"> </span>customer
Tony &lt;-<span class="st"> </span>customer
Evelyn &lt;-<span class="st"> </span>customer

<span class="co"># Modify the timeout of each copy</span>
Klaus[<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(), <span class="dv">10</span>)
Tony[<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(), <span class="dv">7</span>)
Evelyn[<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(), <span class="dv">20</span>)

<span class="co"># Check that the modifications worked</span>
Klaus
<span class="co">#&gt; trajectory: Customer's path, 3 activities</span>
<span class="co">#&gt; { Activity: Log          | message }</span>
<span class="co">#&gt; { Activity: Timeout      | delay: 10 }</span>
<span class="co">#&gt; { Activity: Log          | message }</span>
Tony
<span class="co">#&gt; trajectory: Customer's path, 3 activities</span>
<span class="co">#&gt; { Activity: Log          | message }</span>
<span class="co">#&gt; { Activity: Timeout      | delay: 7 }</span>
<span class="co">#&gt; { Activity: Log          | message }</span>
Evelyn
<span class="co">#&gt; trajectory: Customer's path, 3 activities</span>
<span class="co">#&gt; { Activity: Log          | message }</span>
<span class="co">#&gt; { Activity: Timeout      | delay: 20 }</span>
<span class="co">#&gt; { Activity: Log          | message }</span>

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Klaus"</span>, Klaus, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Tony"</span>, Tony, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">2</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Evelyn"</span>, Evelyn, <span class="kw"><a href="../reference/at.html">at</a></span>(<span class="dv">12</span>))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 2: Tony0: Here I am</span>
<span class="co">#&gt; 5: Klaus0: Here I am</span>
<span class="co">#&gt; 9: Tony0: I must leave</span>
<span class="co">#&gt; 12: Evelyn0: Here I am</span>
<span class="co">#&gt; 15: Klaus0: I must leave</span>
<span class="co">#&gt; 32: Evelyn0: I must leave</span>
<span class="co">#&gt; simmer environment: bank | now: 32 | next: </span>
<span class="co">#&gt; { Generator: Klaus | monitored: 1 | n_generated: 1 }</span>
<span class="co">#&gt; { Generator: Tony | monitored: 1 | n_generated: 1 }</span>
<span class="co">#&gt; { Generator: Evelyn | monitored: 1 | n_generated: 1 }</span>
bank <span class="op">%&gt;%</span><span class="st"> </span>get_mon_arrivals
<span class="co">#&gt;      name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1   Tony0          2        9             7     TRUE           1</span>
<span class="co">#&gt; 2  Klaus0          5       15            10     TRUE           1</span>
<span class="co">#&gt; 3 Evelyn0         12       32            20     TRUE           1</span></code></pre></div>
<p>Again, the simulations finish before the 400 specified in the <code>run</code> function.</p>
</div>
<div id="many-customers" class="section level3">
<h3 class="hasAnchor">
<a href="#many-customers" class="anchor"></a>Many customers</h3>
<p>Another change will allow us to have more customers. To make things clearer we do not use random numbers in this model.</p>
<p>The change is in the <code>add_generator</code> function, where we use a convenience function <code>from_to</code> to create a sequence of start times for five customers, starting at time 0, with an interarrival time of 10 between each customer. One idiosyncracy of the syntax is that no arrival is created on the <code>to</code> time, so we give it as 41, one unit after the last arrival to be generated. Another is that the interarrival time must be specified as a function, hence we define a constant function <code>function() {10}</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"I must leave"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="kw"><a href="../reference/at.html">from_to</a></span>(<span class="dv">0</span>, <span class="dv">41</span>, <span class="cf">function</span>() {<span class="dv">10</span>}))

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 10: Customer1: Here I am</span>
<span class="co">#&gt; 12: Customer0: I must leave</span>
<span class="co">#&gt; 20: Customer2: Here I am</span>
<span class="co">#&gt; 22: Customer1: I must leave</span>
<span class="co">#&gt; 30: Customer3: Here I am</span>
<span class="co">#&gt; 32: Customer2: I must leave</span>
<span class="co">#&gt; 40: Customer4: Here I am</span>
<span class="co">#&gt; 42: Customer3: I must leave</span>
<span class="co">#&gt; 52: Customer4: I must leave</span>
<span class="co">#&gt; simmer environment: bank | now: 52 | next: </span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
bank <span class="op">%&gt;%</span><span class="st"> </span>get_mon_arrivals
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0          0       12            12     TRUE           1</span>
<span class="co">#&gt; 2 Customer1         10       22            12     TRUE           1</span>
<span class="co">#&gt; 3 Customer2         20       32            12     TRUE           1</span>
<span class="co">#&gt; 4 Customer3         30       42            12     TRUE           1</span>
<span class="co">#&gt; 5 Customer4         40       52            12     TRUE           1</span></code></pre></div>
</div>
<div id="many-random-customers" class="section level3">
<h3 class="hasAnchor">
<a href="#many-random-customers" class="anchor"></a>Many random customers</h3>
<p>We now extend this model to allow arrivals at random. In simulation this is usually interpreted as meaning that the times between customer arrivals are distributed as exponential random variates. There is little change in our program. The only difference between this and the previous example of a single customer generated at a random time is that this example generates several customers at different random times.</p>
<p>The change occurs in the arguments to the <code>add_generator</code> function. The function <code>rexp</code> draws from an exponential distribution with the given parameter, which in this case is <code>1/10</code>. See <code>?rexp</code> for more details. We also seed the random number generator with 1289 so that the same sequence of random numbers will be drawn every time the script is run. The 0 is the time of the first customer, then four random interarrival times are drawn, and a final -1 stops the generator.</p>
<p>The reason why we cannot use the <code>from_to</code> function here is that we want to control the number of arrivals that are generated, rather than the end-time of arrival generation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1289</span>)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"I must leave"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 12: Customer0: I must leave</span>
<span class="co">#&gt; 14.3114: Customer1: Here I am</span>
<span class="co">#&gt; 26.3114: Customer1: I must leave</span>
<span class="co">#&gt; 26.5588: Customer2: Here I am</span>
<span class="co">#&gt; 35.8506: Customer3: Here I am</span>
<span class="co">#&gt; 38.2706: Customer4: Here I am</span>
<span class="co">#&gt; 38.5588: Customer2: I must leave</span>
<span class="co">#&gt; 47.8506: Customer3: I must leave</span>
<span class="co">#&gt; 50.2706: Customer4: I must leave</span>
<span class="co">#&gt; simmer environment: bank | now: 50.2705868901582 | next: </span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
bank <span class="op">%&gt;%</span><span class="st"> </span>get_mon_arrivals
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0    0.00000 12.00000            12     TRUE           1</span>
<span class="co">#&gt; 2 Customer1   14.31136 26.31136            12     TRUE           1</span>
<span class="co">#&gt; 3 Customer2   26.55882 38.55882            12     TRUE           1</span>
<span class="co">#&gt; 4 Customer3   35.85064 47.85064            12     TRUE           1</span>
<span class="co">#&gt; 5 Customer4   38.27059 50.27059            12     TRUE           1</span></code></pre></div>
</div>
</div>
<div id="a-service-counter" class="section level2">
<h2 class="hasAnchor">
<a href="#a-service-counter" class="anchor"></a>A Service counter</h2>
<p>So far, the model has been more like an art gallery, the customers entering, looking around, and leaving. Now they are going to require service from the bank clerk. We extend the model to include a service counter that will be modelled as a ‘resource’. The actions of a Resource are simple: a customer requests a unit of the resource (a clerk). If one is free, then the customer gets service (and the unit is no longer available to other customers). If there is no free clerk, then the customer joins the queue (managed by the resource object) until it is the customer’s turn to be served. As each customer completes service and releases the unit, the clerk can start serving the next in line.</p>
<div id="one-service-counter" class="section level3">
<h3 class="hasAnchor">
<a href="#one-service-counter" class="anchor"></a>One Service counter</h3>
<p>The service counter is created with the <code>add_resource</code> function. Default arguments specify that it can serve one customer at a time, and has infinite queueing capacity.</p>
<p>The <code>seize</code> function causes the customer to join the queue at the counter. If the queue is empty and the counter is available (not serving any customers), then the customer claims the counter for itself and moves onto the <code>timeout</code> step. Otherwise the customer must wait until the counter becomes available. Behaviour of the customer while in the queue is controlled by the arguments of the <code>seize</code> function, rather than by any other functions. Once the <code>timeout</code> step is complete, the <code>release</code> function causes the customer to make the counter available to other customers in the queue.</p>
<p>Since the activity trace does not produce the waiting time by default, this is calculated and appended using the <code>mutate</code> function in the dplyr package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1234</span>)

bank &lt;-<span class="st"> </span><span class="kw">simmer</span>()

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="dv">12</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Finished: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank))})

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 0: Customer0: Waited:  0</span>
<span class="co">#&gt; 12: Customer0: Finished:  12</span>
<span class="co">#&gt; 25.0176: Customer1: Here I am</span>
<span class="co">#&gt; 25.0176: Customer1: Waited:  0</span>
<span class="co">#&gt; 27.4852: Customer2: Here I am</span>
<span class="co">#&gt; 27.551: Customer3: Here I am</span>
<span class="co">#&gt; 37.0176: Customer1: Finished:  37.0175860496223</span>
<span class="co">#&gt; 37.0176: Customer2: Waited:  9.53241116646677</span>
<span class="co">#&gt; 44.9785: Customer4: Here I am</span>
<span class="co">#&gt; 49.0176: Customer2: Finished:  49.0175860496223</span>
<span class="co">#&gt; 49.0176: Customer3: Waited:  21.466591599012</span>
<span class="co">#&gt; 61.0176: Customer3: Finished:  61.0175860496223</span>
<span class="co">#&gt; 61.0176: Customer4: Waited:  16.0391307005949</span>
<span class="co">#&gt; 73.0176: Customer4: Finished:  73.0175860496223</span>
<span class="co">#&gt; simmer environment: bank | now: 73.0175860496223 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0    0.00000 12.00000            12     TRUE           1</span>
<span class="co">#&gt; 2 Customer1   25.01759 37.01759            12     TRUE           1</span>
<span class="co">#&gt; 3 Customer2   27.48517 49.01759            12     TRUE           1</span>
<span class="co">#&gt; 4 Customer3   27.55099 61.01759            12     TRUE           1</span>
<span class="co">#&gt; 5 Customer4   44.97846 73.01759            12     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1     0.000000</span>
<span class="co">#&gt; 2     0.000000</span>
<span class="co">#&gt; 3     9.532411</span>
<span class="co">#&gt; 4    21.466592</span>
<span class="co">#&gt; 5    16.039131</span></code></pre></div>
<p>Examining the trace we see that the first two customers get instant service but the others have to wait. We still only have five customers, so we cannot draw general conclusions.</p>
</div>
<div id="a-server-with-a-random-service-time" class="section level3">
<h3 class="hasAnchor">
<a href="#a-server-with-a-random-service-time" class="anchor"></a>A server with a random service time</h3>
<p>This is a simple change to the model in that we retain the single service counter but make the customer service time a random variable. As is traditional in the study of simple queues we first assume an exponential service time.</p>
<p>Note that the argument to <code>timeout</code> must be a function, otherwise it would apply a constant timeout to every customer.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1269</span>)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># timeout(rexp(1, 1/12)) would generate a single random time and use it for</span>
<span class="st">  </span><span class="co"># every arrival, whereas the following line generates a random time for each</span>
<span class="st">  </span><span class="co"># arrival</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">12</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Finished: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank))})

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 0: Customer0: Waited:  0</span>
<span class="co">#&gt; 3.68365: Customer1: Here I am</span>
<span class="co">#&gt; 3.89529: Customer2: Here I am</span>
<span class="co">#&gt; 4.91521: Customer0: Finished:  4.91521483175031</span>
<span class="co">#&gt; 4.91521: Customer1: Waited:  1.23156707156024</span>
<span class="co">#&gt; 10.961: Customer3: Here I am</span>
<span class="co">#&gt; 12.4143: Customer4: Here I am</span>
<span class="co">#&gt; 21.0552: Customer1: Finished:  21.055182798071</span>
<span class="co">#&gt; 21.0552: Customer2: Waited:  17.1598927142276</span>
<span class="co">#&gt; 65.3116: Customer2: Finished:  65.3115507844349</span>
<span class="co">#&gt; 65.3116: Customer3: Waited:  54.3505873236467</span>
<span class="co">#&gt; 80.1134: Customer3: Finished:  80.1133545241526</span>
<span class="co">#&gt; 80.1134: Customer4: Waited:  67.6990166719428</span>
<span class="co">#&gt; 93.7286: Customer4: Finished:  93.7285504163997</span>
<span class="co">#&gt; simmer environment: bank | now: 93.7285504163997 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time  end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0   0.000000  4.915215      4.915215     TRUE           1</span>
<span class="co">#&gt; 2 Customer1   3.683648 21.055183     16.139968     TRUE           1</span>
<span class="co">#&gt; 3 Customer2   3.895290 65.311551     44.256368     TRUE           1</span>
<span class="co">#&gt; 4 Customer3  10.960963 80.113355     14.801804     TRUE           1</span>
<span class="co">#&gt; 5 Customer4  12.414338 93.728550     13.615196     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1     0.000000</span>
<span class="co">#&gt; 2     1.231567</span>
<span class="co">#&gt; 3    17.159893</span>
<span class="co">#&gt; 4    54.350587</span>
<span class="co">#&gt; 5    67.699017</span></code></pre></div>
<p>This model with random arrivals and exponential service times is an example of an M/M/1 queue and could rather easily be solved analytically to calculate the steady-state mean waiting time and other operating characteristics. (But not so easily solved for its transient behavior.)</p>
</div>
</div>
<div id="several-service-counters" class="section level2">
<h2 class="hasAnchor">
<a href="#several-service-counters" class="anchor"></a>Several Service Counters</h2>
<p>When we introduce several counters we must decide on a queue discipline. Are customers going to make one queue or are they going to form separate queues in front of each counter? Then there are complications - will they be allowed to switch lines (jockey)? We first consider a single queue with several counters and later consider separate isolated queues. We will not look at jockeying.</p>
<div id="several-counters-but-a-single-queue" class="section level3">
<h3 class="hasAnchor">
<a href="#several-counters-but-a-single-queue" class="anchor"></a>Several Counters but a Single Queue</h3>
<p>Here we model a bank whose customers arrive randomly and are to be served at a group of counters, taking a random time for service, where we assume that waiting customers form a single first-in first-out queue.</p>
<p>The only difference between this model and the single-server model is in the <code>add_resource</code> function, where we have increased the capacity to two so that it can serve two customers at once.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1269</span>)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">12</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Finished: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank))})

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>, <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Here is the change</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 0: Customer0: Waited:  0</span>
<span class="co">#&gt; 3.68365: Customer1: Here I am</span>
<span class="co">#&gt; 3.68365: Customer1: Waited:  0</span>
<span class="co">#&gt; 3.89529: Customer2: Here I am</span>
<span class="co">#&gt; 4.91521: Customer0: Finished:  4.91521483175031</span>
<span class="co">#&gt; 4.91521: Customer2: Waited:  1.01992474790691</span>
<span class="co">#&gt; 10.961: Customer3: Here I am</span>
<span class="co">#&gt; 12.4143: Customer4: Here I am</span>
<span class="co">#&gt; 19.8236: Customer1: Finished:  19.8236157265107</span>
<span class="co">#&gt; 19.8236: Customer3: Waited:  8.86265226572255</span>
<span class="co">#&gt; 34.6254: Customer3: Finished:  34.6254194662285</span>
<span class="co">#&gt; 34.6254: Customer4: Waited:  22.2110816140186</span>
<span class="co">#&gt; 48.2406: Customer4: Finished:  48.2406153584756</span>
<span class="co">#&gt; 49.1716: Customer2: Finished:  49.1715828181142</span>
<span class="co">#&gt; simmer environment: bank | now: 49.1715828181142 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(2) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
<span class="co">#&gt;        name start_time  end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0   0.000000  4.915215      4.915215     TRUE           1</span>
<span class="co">#&gt; 2 Customer1   3.683648 19.823616     16.139968     TRUE           1</span>
<span class="co">#&gt; 3 Customer3  10.960963 34.625419     14.801804     TRUE           1</span>
<span class="co">#&gt; 4 Customer4  12.414338 48.240615     13.615196     TRUE           1</span>
<span class="co">#&gt; 5 Customer2   3.895290 49.171583     44.256368     TRUE           1</span>
<span class="co">#&gt;   waiting_time</span>
<span class="co">#&gt; 1     0.000000</span>
<span class="co">#&gt; 2     0.000000</span>
<span class="co">#&gt; 3     8.862652</span>
<span class="co">#&gt; 4    22.211082</span>
<span class="co">#&gt; 5     1.019925</span></code></pre></div>
<p>The waiting times in this model are much shorter than those for the single service counter. For example, the waiting time for Customer3 has been reduced from nearly 17 minutes to less than 9. Again we have too few customers processed to draw general conclusions.</p>
</div>
<div id="several-counters-with-individual-queues" class="section level3">
<h3 class="hasAnchor">
<a href="#several-counters-with-individual-queues" class="anchor"></a>Several Counters with individual queues</h3>
<p>Each counter is now assumed to have its own queue. The programming is more complicated because the customer has to decide which queue to join. The obvious technique is to make each counter a separate resource.</p>
<p>In practice, a customer might join the shortest queue. We implement this behaviour by first selecting the shortest queue, using the <code>select</code> function. Then we use <code>seize_selected</code> to enter the chosen queue, and later <code>release_selected</code>.</p>
<p>The rest of the program is the same as before.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">1014</span>)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="st">"Here I am"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/set_attribute.html">set_attribute</a></span>(<span class="st">"start_time"</span>, <span class="cf">function</span>() {<span class="kw"><a href="../reference/now.html">now</a></span>(bank)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/select.html">select</a></span>(<span class="kw">c</span>(<span class="st">"counter1"</span>, <span class="st">"counter2"</span>), <span class="dt">policy =</span> <span class="st">"shortest-queue"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize_selected</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Waited: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/get_n_generated.html">get_attribute</a></span>(bank, <span class="st">"start_time"</span>))}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">12</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release_selected</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/log_.html">log_</a></span>(<span class="cf">function</span>() {<span class="kw">paste</span>(<span class="st">"Finished: "</span>, <span class="kw"><a href="../reference/now.html">now</a></span>(bank))})

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter1"</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter2"</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
<span class="co">#&gt; 0: Customer0: Here I am</span>
<span class="co">#&gt; 0: Customer0: Waited:  0</span>
<span class="co">#&gt; 23.7144: Customer1: Here I am</span>
<span class="co">#&gt; 23.7144: Customer1: Waited:  0</span>
<span class="co">#&gt; 30.4011: Customer2: Here I am</span>
<span class="co">#&gt; 32.4163: Customer3: Here I am</span>
<span class="co">#&gt; 33.941: Customer1: Finished:  33.94103133502</span>
<span class="co">#&gt; 33.941: Customer3: Waited:  1.52471543798104</span>
<span class="co">#&gt; 39.5302: Customer3: Finished:  39.5301990230619</span>
<span class="co">#&gt; 48.8559: Customer4: Here I am</span>
<span class="co">#&gt; 48.8559: Customer4: Waited:  0</span>
<span class="co">#&gt; 55.3965: Customer4: Finished:  55.3964510986066</span>
<span class="co">#&gt; 62.1037: Customer0: Finished:  62.1037152193123</span>
<span class="co">#&gt; 62.1037: Customer2: Waited:  31.7026170465295</span>
<span class="co">#&gt; 62.3885: Customer2: Finished:  62.3885266177193</span>
<span class="co">#&gt; simmer environment: bank | now: 62.3885266177193 | next: </span>
<span class="co">#&gt; { Resource: counter1 | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Resource: counter2 | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 5 }</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">service_start_time =</span> end_time <span class="op">-</span><span class="st"> </span>activity_time) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/arrange">arrange</a></span>(start_time)
<span class="co">#&gt;        name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 Customer0    0.00000 62.10372    62.1037152     TRUE           1</span>
<span class="co">#&gt; 2 Customer1   23.71444 33.94103    10.2265939     TRUE           1</span>
<span class="co">#&gt; 3 Customer2   30.40110 62.38853     0.2848114     TRUE           1</span>
<span class="co">#&gt; 4 Customer3   32.41632 39.53020     5.5891677     TRUE           1</span>
<span class="co">#&gt; 5 Customer4   48.85593 55.39645     6.5405163     TRUE           1</span>
<span class="co">#&gt;   service_start_time</span>
<span class="co">#&gt; 1            0.00000</span>
<span class="co">#&gt; 2           23.71444</span>
<span class="co">#&gt; 3           62.10372</span>
<span class="co">#&gt; 4           33.94103</span>
<span class="co">#&gt; 5           48.85593</span>
bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_resources <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/arrange">arrange</a></span>(time)
<span class="co">#&gt;    resource     time server queue capacity queue_size system limit</span>
<span class="co">#&gt; 1  counter1  0.00000      1     0        1        Inf      1   Inf</span>
<span class="co">#&gt; 2  counter2 23.71444      1     0        1        Inf      1   Inf</span>
<span class="co">#&gt; 3  counter1 30.40110      1     1        1        Inf      2   Inf</span>
<span class="co">#&gt; 4  counter2 32.41632      1     1        1        Inf      2   Inf</span>
<span class="co">#&gt; 5  counter2 33.94103      1     0        1        Inf      1   Inf</span>
<span class="co">#&gt; 6  counter2 39.53020      0     0        1        Inf      0   Inf</span>
<span class="co">#&gt; 7  counter2 48.85593      1     0        1        Inf      1   Inf</span>
<span class="co">#&gt; 8  counter2 55.39645      0     0        1        Inf      0   Inf</span>
<span class="co">#&gt; 9  counter1 62.10372      1     0        1        Inf      1   Inf</span>
<span class="co">#&gt; 10 counter1 62.38853      0     0        1        Inf      0   Inf</span>
<span class="co">#&gt;    replication</span>
<span class="co">#&gt; 1            1</span>
<span class="co">#&gt; 2            1</span>
<span class="co">#&gt; 3            1</span>
<span class="co">#&gt; 4            1</span>
<span class="co">#&gt; 5            1</span>
<span class="co">#&gt; 6            1</span>
<span class="co">#&gt; 7            1</span>
<span class="co">#&gt; 8            1</span>
<span class="co">#&gt; 9            1</span>
<span class="co">#&gt; 10           1</span></code></pre></div>
<p>The results show that the customers chose the counter with the smallest number. Unlucky Customer2 who joins the wrong queue has to wait until Customer0 finishes at time 62.10372, and is the last to leave. There are, however, too few arrivals in these runs, limited as they are to five customers, to draw any general conclusions about the relative efficiencies of the two systems.</p>
</div>
<div id="the-bank-with-a-monitor-aka-summary-statistics" class="section level3">
<h3 class="hasAnchor">
<a href="#the-bank-with-a-monitor-aka-summary-statistics" class="anchor"></a>The bank with a monitor (aka summary statistics)</h3>
<p>We now demonstrate how to calculate average waiting times for our customers. In the original SimPy version of this tutorial, this involved using ‘Monitors’. In simmer, data is returned by the <code>get_mon_*</code> family of functions, as has already been demonstrated. Here, we simply summarise the data frame returned by the <code>get_mon_arrivals</code> function, using functions from the <code>dplyr</code> package.</p>
<p>We also increase the number of customers to 50 (find the number ‘49’ in the code.code).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

<span class="kw">set.seed</span>(<span class="dv">100005</span>)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">12</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>)

bank &lt;-
<span class="st">  </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>, <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">49</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">1000</span>)
<span class="co">#&gt; simmer environment: bank | now: 650.615510598544 | next: </span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(2) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Generator: Customer | monitored: 1 | n_generated: 50 }</span>

result &lt;-
<span class="st">  </span>bank <span class="op">%&gt;%</span>
<span class="st">  </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)</code></pre></div>
<p>The average waiting time for 50 customers in this 2-counter system is more reliable (i.e., less subject to random simulation effects) than the times we measured before but it is still not sufficiently reliable for real-world decisions. We should also replicate the runs using different random number seeds. The result of this run is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">paste</span>(<span class="st">"Average wait for "</span>, <span class="kw">sum</span>(result<span class="op">$</span>finished), <span class="st">" completions was "</span>,
      <span class="kw">mean</span>(result<span class="op">$</span>waiting_time), <span class="st">"minutes."</span>)
<span class="co">#&gt; [1] "Average wait for  50  completions was  3.05085138406832 minutes."</span></code></pre></div>
</div>
<div id="multiple-runs" class="section level3">
<h3 class="hasAnchor">
<a href="#multiple-runs" class="anchor"></a>Multiple runs</h3>
<p>To get a number of independent measurements we must replicate the runs using different random number seeds. Each replication must be independent of previous ones, so the environment (bank) must be redefined for each run, so that the random interarrival times in the <code>add_generator</code> function are generated from scratch.</p>
<p>We take the chunks of code that build the environment (bank) and run the simulation, and wrap them in the <code>mclapply</code> function from the ‘parallel’ package. This function runs each simulation in parallel, using the available cores in the computer’s processor. Because we use seeds for reproducability, we pass these to the function that runs the simulation (<code>function(the_seed)</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)
<span class="kw">library</span>(parallel)

customer &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/trajectory.html">trajectory</a></span>(<span class="st">"Customer's path"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">seize</a></span>(<span class="st">"counter"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/timeout.html">timeout</a></span>(<span class="cf">function</span>() {<span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">12</span>)}) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/seize.html">release</a></span>(<span class="st">"counter"</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(<span class="kw">c</span>(<span class="dv">393943</span>, <span class="dv">100005</span>, <span class="dv">777999555</span>, <span class="dv">319999772</span>), <span class="cf">function</span>(the_seed) {
  <span class="kw">set.seed</span>(the_seed)

  bank &lt;-
<span class="st">    </span><span class="kw">simmer</span>(<span class="st">"bank"</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/add_resource.html">add_resource</a></span>(<span class="st">"counter"</span>, <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/add_generator.html">add_generator</a></span>(<span class="st">"Customer"</span>, customer, <span class="cf">function</span>() {<span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">rexp</span>(<span class="dv">49</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="op">-</span><span class="dv">1</span>)})

  bank <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/run.html">run</a></span>(<span class="dt">until =</span> <span class="dv">400</span>)
  result &lt;-
<span class="st">    </span>bank <span class="op">%&gt;%</span>
<span class="st">    </span>get_mon_arrivals <span class="op">%&gt;%</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/mutate">mutate</a></span>(<span class="dt">waiting_time =</span> end_time <span class="op">-</span><span class="st"> </span>start_time <span class="op">-</span><span class="st"> </span>activity_time)
  <span class="kw">paste</span>(<span class="st">"Average wait for "</span>, <span class="kw">sum</span>(result<span class="op">$</span>finished), <span class="st">" completions was "</span>,
        <span class="kw">mean</span>(result<span class="op">$</span>waiting_time), <span class="st">"minutes."</span>)
}) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()
<span class="co">#&gt; [1] "Average wait for  49  completions was  3.4958501806687 minutes."  </span>
<span class="co">#&gt; [2] "Average wait for  29  completions was  0.584941574937737 minutes."</span>
<span class="co">#&gt; [3] "Average wait for  32  completions was  1.00343842138177 minutes." </span>
<span class="co">#&gt; [4] "Average wait for  42  completions was  7.41231393636088 minutes."</span></code></pre></div>
<p>The results show some variation. Remember, though, that the system is still only operating for 50 customers, so the system may not be in steady-state.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#a-single-customer">A single customer</a></li>
      <li><a href="#a-service-counter">A Service counter</a></li>
      <li><a href="#several-service-counters">Several Service Counters</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Iñaki Ucar, Bart Smeets.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
