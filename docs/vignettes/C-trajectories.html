<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Bart Smeets, Iñaki Ucar" />

<meta name="date" content="2016-06-28" />

<title>Advanced Trajectory Usage</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Advanced Trajectory Usage</h1>
<h4 class="author"><em>Bart Smeets, Iñaki Ucar</em></h4>
<h4 class="date"><em>2016-06-28</em></h4>


<div id="TOC">
<ul>
<li><a href="#available-set-of-activities">Available set of activities</a><ul>
<li><a href="#set_attribute">set_attribute</a></li>
<li><a href="#seize-release">seize &amp; release</a></li>
<li><a href="#timeout">timeout</a></li>
<li><a href="#branch">branch</a></li>
<li><a href="#rollback">rollback</a></li>
</ul></li>
<li><a href="#concatenating-trajectories">Concatenating trajectories</a></li>
<li><a href="#interacting-with-the-environment-from-within-a-trajectory">Interacting with the environment from within a trajectory</a></li>
</ul>
</div>

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(dplyr)</code></pre></div>
<div id="available-set-of-activities" class="section level2">
<h2>Available set of activities</h2>
<p>When a generator creates an arrival, it couples the arrival to a given trajectory. A trajectory is defined as an interlinkage of activities which together form the arrivals’ lifetime in the system. Once an arrival is coupled to the trajectory, it will (in general) start processing the activities in the trajectory in the specified order and, eventually, leave the system. Consider the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_traj&lt;-
<span class="st">  </span><span class="kw">create_trajectory</span>(<span class="dt">name =</span> <span class="st">&quot;patient_trajectory&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">seize</span>(<span class="dt">resource =</span> <span class="st">&quot;doctor&quot;</span>, <span class="dt">amount =</span> <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">3</span>) %&gt;%
<span class="st">  </span><span class="kw">release</span>(<span class="dt">resource =</span> <span class="st">&quot;doctor&quot;</span>, <span class="dt">amount =</span> <span class="dv">1</span>)</code></pre></div>
<p>Here we create a trajectory where a patient <em>seizes</em> a doctor for 3 minutes and then <em>releases</em> him again.</p>
<p>This is a very straightforward example, however, most of the trajectory-related functions allow for more advanced usage. The different functions are introduced below.</p>
<div id="set_attribute" class="section level3">
<h3>set_attribute</h3>
<p>The <code>set_attribute(trajectory, key, value)</code> function set the <code>value</code> of an arrival’s attribute <code>key</code>. Be aware that <code>value</code> can only be numeric.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_traj&lt;-
<span class="st">  </span><span class="kw">create_trajectory</span>(<span class="dt">name =</span> <span class="st">&quot;patient_trajectory&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;my_key&quot;</span>, <span class="dv">123</span>) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;my_key&quot;</span>, <span class="dv">456</span>)

env&lt;-
<span class="st">  </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;patient&quot;</span>, patient_traj, <span class="kw">at</span>(<span class="dv">0</span>), <span class="dt">mon =</span> <span class="dv">2</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>()

<span class="kw">get_mon_attributes</span>(env)
<span class="co">#&gt;   time     name    key value replication</span>
<span class="co">#&gt; 1    0 patient0 my_key   123           1</span>
<span class="co">#&gt; 2    5 patient0 my_key   456           1</span></code></pre></div>
<p>Above, a trajectory which <em>only</em> sets attribute <code>my_key</code> to value <code>123</code> is launched once by an arrival generated at time 0 (check <code>?at</code>). Using <code>get_mon_attributes</code> we can look at the evolution of the value of <code>my_key</code>.</p>
<p>If you want to set an attribute that depends on another attribute, or on the current value of the attribute to be set, this is also possible. In fact, if, instead of a numeric value, you supply a function with one parameter, the current set of attributes is passed as a list to that function. Whatever (numeric value) your function returns is set as the value of the specified attribute key. If the supplied function has no parameters, it is evaluated in the same way, but the attribute list is not accesible in the function body. This means that, if you supply a function to the <code>value</code> parameter, it has to be in the form of either <code>function(attrs){}</code> (first case) or <code>function(){}</code> (second case). Below, you can see an example of this in practice.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_traj&lt;-
<span class="st">  </span><span class="kw">create_trajectory</span>(<span class="dt">name =</span> <span class="st">&quot;patient_trajectory&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;my_key&quot;</span>, <span class="dv">123</span>) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;my_key&quot;</span>, function(attrs) attrs[[<span class="st">&quot;my_key&quot;</span>]] +<span class="st"> </span><span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;dependent_key&quot;</span>, function(attrs) <span class="kw">ifelse</span>(attrs[[<span class="st">&quot;my_key&quot;</span>]]&lt;=<span class="dv">123</span>, <span class="dv">1</span>, <span class="dv">0</span>)) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">5</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;independent_key&quot;</span>, function() <span class="kw">runif</span>(<span class="dv">1</span>))

env&lt;-
<span class="st">  </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;patient&quot;</span>, patient_traj, <span class="kw">at</span>(<span class="dv">0</span>), <span class="dt">mon =</span> <span class="dv">2</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>()

<span class="kw">get_mon_attributes</span>(env)
<span class="co">#&gt;   time     name             key       value replication</span>
<span class="co">#&gt; 1    0 patient0          my_key 123.0000000           1</span>
<span class="co">#&gt; 2    5 patient0          my_key 124.0000000           1</span>
<span class="co">#&gt; 3   10 patient0   dependent_key   0.0000000           1</span>
<span class="co">#&gt; 4   15 patient0 independent_key   0.2453603           1</span></code></pre></div>
</div>
<div id="seize-release" class="section level3">
<h3>seize &amp; release</h3>
<p>The <code>seize(trajectory, resource, amount)</code> function seizes a specified <code>amount</code> of resources of type <code>resource</code>. Conversely, the <code>release(trajectory, resource, amount)</code> function releases a specified <code>amount</code> of resource of type <code>resource</code>. Be aware that, in order to use these functions in relation to a specific resource type, you have to create that resource type in your definition of the simulation environment (check <code>?add_resource</code>).</p>
<p>Consider the following example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_traj&lt;-
<span class="st">  </span><span class="kw">create_trajectory</span>(<span class="dt">name =</span> <span class="st">&quot;patient_trajectory&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">seize</span>(<span class="dt">resource =</span> <span class="st">&quot;doctor&quot;</span>, <span class="dt">amount =</span> <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">3</span>) %&gt;%
<span class="st">  </span><span class="kw">release</span>(<span class="dt">resource =</span> <span class="st">&quot;doctor&quot;</span>, <span class="dt">amount =</span> <span class="dv">1</span>)

env&lt;-
<span class="st">  </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;doctor&quot;</span>, <span class="dt">capacity=</span><span class="dv">1</span>, <span class="dt">mon =</span> <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;patient&quot;</span>, patient_traj, <span class="kw">at</span>(<span class="dv">0</span>)) %&gt;%
<span class="st">  </span><span class="kw">run</span>()

<span class="kw">get_mon_resources</span>(env)
<span class="co">#&gt;   time server queue capacity queue_size system limit resource replication</span>
<span class="co">#&gt; 1    0      1     0        1        Inf      1   Inf   doctor           1</span>
<span class="co">#&gt; 2    3      0     0        1        Inf      0   Inf   doctor           1</span></code></pre></div>
<p>Here the <code>mon=1</code> argument (=default) of <code>add_resource</code> makes the simulation environment monitor the resource usage. Using the <code>get_mon_resources(env)</code> function you can get access to the log of the usage evolution of resources.</p>
<p>There are situations where you want to let the amount of resources seized/released be dependent on a specific function or on a previously set attribute. To achieve this, you can pass a function in the form of either <code>function(){}</code> or <code>function(attrs){}</code> to the <code>amount</code> parameter instead of a numeric value. If going for the latter, the current state of the arrival’s attributes will be passed to <code>attrs</code> as a list which you can inspect. This allows for the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_traj&lt;-
<span class="st">  </span><span class="kw">create_trajectory</span>(<span class="dt">name =</span> <span class="st">&quot;patient_trajectory&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;health&quot;</span>, function() <span class="kw">sample</span>(<span class="dv">20</span>:<span class="dv">80</span>, <span class="dv">1</span>)) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;docs_to_seize&quot;</span>, function(attrs) <span class="kw">ifelse</span>(attrs[[<span class="st">&quot;health&quot;</span>]]&lt;<span class="dv">50</span>, <span class="dv">1</span>, <span class="dv">2</span>)) %&gt;%
<span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;doctor&quot;</span>, function(attrs) attrs[[<span class="st">&quot;docs_to_seize&quot;</span>]]) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">3</span>) %&gt;%
<span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;doctor&quot;</span>, function(attrs) attrs[[<span class="st">&quot;docs_to_seize&quot;</span>]])

env&lt;-
<span class="st">  </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;doctor&quot;</span>, <span class="dt">capacity=</span><span class="dv">2</span>, <span class="dt">mon =</span> <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;patient&quot;</span>, patient_traj, <span class="kw">at</span>(<span class="dv">0</span>), <span class="dt">mon=</span><span class="dv">2</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>()

<span class="kw">get_mon_resources</span>(env)
<span class="co">#&gt;   time server queue capacity queue_size system limit resource replication</span>
<span class="co">#&gt; 1    0      2     0        2        Inf      2   Inf   doctor           1</span>
<span class="co">#&gt; 2    3      0     0        2        Inf      0   Inf   doctor           1</span>
<span class="kw">get_mon_attributes</span>(env)
<span class="co">#&gt;   time     name           key value replication</span>
<span class="co">#&gt; 1    0 patient0        health    51           1</span>
<span class="co">#&gt; 2    0 patient0 docs_to_seize     2           1</span></code></pre></div>
</div>
<div id="timeout" class="section level3">
<h3>timeout</h3>
<p>At its simplest, the <code>timeout(trajectory, task)</code> function delays the arrival’s advance through the trajectory for a specified amount of time. Consider the following minimal example where we simply supply a static value to the timeout’s <code>task</code> parameter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_traj&lt;-
<span class="st">  </span><span class="kw">create_trajectory</span>(<span class="dt">name =</span> <span class="st">&quot;patient_trajectory&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">3</span>)

env&lt;-
<span class="st">  </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;doctor&quot;</span>, <span class="dt">capacity=</span><span class="dv">2</span>, <span class="dt">mon =</span> <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;patient&quot;</span>, patient_traj, <span class="kw">at</span>(<span class="dv">0</span>), <span class="dt">mon=</span><span class="dv">2</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>()

<span class="kw">get_mon_arrivals</span>(env)
<span class="co">#&gt;       name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 patient0          0        3             3     TRUE           1</span></code></pre></div>
<p>Often, however, you want a timeout to be dependent on a distribution or, for example, an earlier set attribute. This is achieved by passing a function in to form of either <code>function(){}</code> or <code>function(attrs){}</code> to the <code>task</code> parameter. In the following example this functionality is demonstrated:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_traj&lt;-
<span class="st">  </span><span class="kw">create_trajectory</span>(<span class="dt">name =</span> <span class="st">&quot;patient_trajectory&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;health&quot;</span>, function() <span class="kw">sample</span>(<span class="dv">20</span>:<span class="dv">80</span>, <span class="dv">1</span>)) %&gt;%
<span class="st">  </span><span class="co"># distribution-based timeout</span>
<span class="st">  </span><span class="kw">timeout</span>(function() <span class="kw">rpois</span>(<span class="dv">1</span>, <span class="dv">10</span>)) %&gt;%
<span class="st">  </span><span class="co"># attribute-dependent timeout</span>
<span class="st">  </span><span class="kw">timeout</span>(function(attrs) (<span class="dv">100</span> -<span class="st"> </span>attrs[[<span class="st">&quot;health&quot;</span>]]) *<span class="st"> </span><span class="dv">2</span>)

env&lt;-
<span class="st">  </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;patient&quot;</span>, patient_traj, <span class="kw">at</span>(<span class="dv">0</span>), <span class="dt">mon=</span><span class="dv">2</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>()

<span class="kw">get_mon_arrivals</span>(env)
<span class="co">#&gt;       name start_time end_time activity_time finished replication</span>
<span class="co">#&gt; 1 patient0          0       72            72     TRUE           1</span>
<span class="kw">get_mon_attributes</span>(env)
<span class="co">#&gt;   time     name    key value replication</span>
<span class="co">#&gt; 1    0 patient0 health    67           1</span></code></pre></div>
<p>Be aware that if you want the <code>timeout</code>’s <code>task</code> parameter to be evaluated dynamically, you should supply a callable function. For example in <code>timeout(function() rpois(1, 10))</code>, <code>rpois(1, 10)</code> will be evaluated every time the timeout activity is executed. However, if you supply it in the form of <code>timeout(rpois(1, 10))</code>, it will only be evaluated at initalization and will remain static after that.</p>
<p>Of course, this <code>task</code>, supplied as a function, may be as complex as you need and, for instance, check a resource’s status, interact with other entities in your simulation model… The same applies to all previous activities when they accept a function as a parameter.</p>
</div>
<div id="branch" class="section level3">
<h3>branch</h3>
<p>The <code>branch(trajectory, option, continue, ...)</code> method offers the possibility of adding alternative paths in the trajectory. The following example shows how a trajectory can be built with a 50-50 chance for an arrival to pass through each path of a two-path branch.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t1 &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>(<span class="st">&quot;trajectory with a branch&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;server&quot;</span>, <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">branch</span>(function() <span class="kw">sample</span>(<span class="dv">1</span>:<span class="dv">2</span>, <span class="dv">1</span>), <span class="dt">continue=</span><span class="kw">c</span>(T, F), 
         <span class="kw">create_trajectory</span>(<span class="st">&quot;branch1&quot;</span>) %&gt;%
<span class="st">           </span><span class="kw">timeout</span>(function() <span class="dv">1</span>),
         <span class="kw">create_trajectory</span>(<span class="st">&quot;branch2&quot;</span>) %&gt;%
<span class="st">           </span><span class="kw">timeout</span>(function() <span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">3</span>)) %&gt;%
<span class="st">           </span><span class="kw">release</span>(<span class="st">&quot;server&quot;</span>, <span class="dv">1</span>)
  ) %&gt;%
<span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;server&quot;</span>, <span class="dv">1</span>)</code></pre></div>
<p>When an arrival gets to the branch, the first argument is evaluated to select a specific path to follow, so it must be callable and must return a numeric value between 1 and <code>n</code>, where <code>n</code> is the number of paths defined. The second argument, <code>continue</code>, indicates whether the arrival must continue executing the activities after the selected path or not. In the example above, only the first path continues to the last <em>release</em>.</p>
<p>Sometimes you may need to count how many times a certain trajectory in a certain branch is entered, or how much time arrivals spend inside that trajectory. For these situations, it is handy to use resources with infinite capacity just for <em>accounting</em> purposes, like in the example below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t0 &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%
<span class="st">  </span><span class="kw">branch</span>(function() <span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dv">1</span>), <span class="kw">c</span>(T, T),
         <span class="kw">create_trajectory</span>() %&gt;%
<span class="st">           </span><span class="kw">seize</span>(<span class="st">&quot;branch1&quot;</span>, <span class="dv">1</span>) %&gt;%
<span class="st">           </span><span class="co"># do stuff here</span>
<span class="st">           </span><span class="kw">timeout</span>(function() <span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span>)) %&gt;%
<span class="st">           </span><span class="kw">release</span>(<span class="st">&quot;branch1&quot;</span>, <span class="dv">1</span>),
         <span class="kw">create_trajectory</span>() %&gt;%
<span class="st">           </span><span class="kw">seize</span>(<span class="st">&quot;branch2&quot;</span>, <span class="dv">1</span>) %&gt;%
<span class="st">           </span><span class="co"># do stuff here</span>
<span class="st">           </span><span class="kw">timeout</span>(function() <span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span>/<span class="dv">2</span>)) %&gt;%
<span class="st">           </span><span class="kw">release</span>(<span class="st">&quot;branch2&quot;</span>, <span class="dv">1</span>))

env &lt;-<span class="st"> </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;dummy&quot;</span>, t0, <span class="kw">at</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">1000</span>))) %&gt;%
<span class="st">  </span><span class="co"># Resources with infinite capacity, just for accounting purposes</span>
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;branch1&quot;</span>, <span class="ot">Inf</span>) %&gt;%
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;branch2&quot;</span>, <span class="ot">Inf</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>()

arrivals &lt;-<span class="st"> </span><span class="kw">get_mon_arrivals</span>(env, <span class="dt">per_resource =</span> T)

<span class="co"># Times that each branch was entered</span>
arrivals %&gt;%<span class="st"> </span><span class="kw">count</span>(resource)
<span class="co">#&gt; Source: local data frame [2 x 2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   resource     n</span>
<span class="co">#&gt;     &lt;fctr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1  branch1   506</span>
<span class="co">#&gt; 2  branch2   494</span>

<span class="co"># The `activity_time` is the total time inside each branch for each arrival</span>
<span class="co"># Let's see the distributions</span>
<span class="kw">ggplot</span>(arrivals) +<span class="st"> </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x=</span>activity_time)) +<span class="st"> </span><span class="kw">facet_wrap</span>(~resource)</code></pre></div>
<p><img src="data:image/png;base64,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" style="display: block; margin: auto;" /></p>
</div>
<div id="rollback" class="section level3">
<h3>rollback</h3>
<p>The <code>rollback(trajectory, amount, times, check)</code> function allows an arrival to rollback the trajectory an <code>amount</code> number of steps.</p>
<p>Consider the following where a string is printed in the timeout function. After the first run, the trajectory is rolled back 3 times.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t0&lt;-<span class="kw">create_trajectory</span>() %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(function(){
    <span class="kw">print</span>(<span class="st">&quot;Hello!&quot;</span>)
    <span class="dv">0</span>}) %&gt;%
<span class="st">  </span><span class="kw">rollback</span>(<span class="dt">amount=</span><span class="dv">1</span>, <span class="dt">times=</span><span class="dv">3</span>)

<span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;hello_sayer&quot;</span>, t0, <span class="kw">at</span>(<span class="dv">0</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">run</span>()
<span class="co">#&gt; [1] &quot;Hello!&quot;</span>
<span class="co">#&gt; [1] &quot;Hello!&quot;</span>
<span class="co">#&gt; [1] &quot;Hello!&quot;</span>
<span class="co">#&gt; [1] &quot;Hello!&quot;</span>
<span class="co">#&gt; simmer environment: anonymous | now: 0 | next: </span>
<span class="co">#&gt; { Generator: hello_sayer | monitored: 1 | n_generated: 1 }</span></code></pre></div>
<p>The <code>rollback</code> function also accepts an optional <code>check</code> parameter which overrides the default amount-based behaviour. This parameter must be a function that returns a logical value. Each time an arrival reaches the activity, this <code>check</code> is evaluated to determine whether the <code>rollback</code> with <code>amount</code> steps must be performed or not. Consider the following example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t0&lt;-<span class="kw">create_trajectory</span>() %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;happiness&quot;</span>, <span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="co"># the timeout function is used simply to print something and returns 0,</span>
<span class="st">  </span><span class="co"># hence it is a dummy timeout</span>
<span class="st">  </span><span class="kw">timeout</span>(function(attrs){
    <span class="kw">cat</span>(<span class="st">&quot;&gt;&gt; Happiness level is at: &quot;</span>, attrs[[<span class="st">&quot;happiness&quot;</span>]], <span class="st">&quot; -- &quot;</span>)
    <span class="kw">cat</span>(<span class="kw">ifelse</span>(attrs[[<span class="st">&quot;happiness&quot;</span>]]&lt;<span class="dv">25</span>,<span class="st">&quot;PETE: I'm feeling crappy...&quot;</span>,
               <span class="kw">ifelse</span>(attrs[[<span class="st">&quot;happiness&quot;</span>]]&lt;<span class="dv">50</span>,<span class="st">&quot;PETE: Feelin' a bit moody&quot;</span>,
                      <span class="kw">ifelse</span>(attrs[[<span class="st">&quot;happiness&quot;</span>]]&lt;<span class="dv">75</span>,<span class="st">&quot;PETE: Just had a good espresso&quot;</span>,
                             <span class="st">&quot;PETE: Let's do this! (and stop this loop...)&quot;</span>)))
        , <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)
    <span class="kw">return</span>(<span class="dv">0</span>)
  }) %&gt;%
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;happiness&quot;</span>, function(attrs) attrs[[<span class="st">&quot;happiness&quot;</span>]] +<span class="st"> </span><span class="dv">25</span>) %&gt;%
<span class="st">  </span><span class="kw">rollback</span>(<span class="dt">amount=</span><span class="dv">2</span>, <span class="dt">check=</span>function(attrs) attrs[[<span class="st">&quot;happiness&quot;</span>]] &lt;<span class="st"> </span><span class="dv">100</span>)

<span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;mood_swinger&quot;</span>, t0, <span class="kw">at</span>(<span class="dv">0</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">run</span>()
<span class="co">#&gt; &gt;&gt; Happiness level is at:  0  -- PETE: I'm feeling crappy... </span>
<span class="co">#&gt; &gt;&gt; Happiness level is at:  25  -- PETE: Feelin' a bit moody </span>
<span class="co">#&gt; &gt;&gt; Happiness level is at:  50  -- PETE: Just had a good espresso </span>
<span class="co">#&gt; &gt;&gt; Happiness level is at:  75  -- PETE: Let's do this! (and stop this loop...)</span>
<span class="co">#&gt; simmer environment: anonymous | now: 0 | next: </span>
<span class="co">#&gt; { Generator: mood_swinger | monitored: 1 | n_generated: 1 }</span></code></pre></div>
</div>
</div>
<div id="concatenating-trajectories" class="section level2">
<h2>Concatenating trajectories</h2>
<p>It is possible to concatenate together any number of trajectories using the <code>join(...)</code> verb. It may be used as a standalone function as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t1 &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%<span class="st"> </span><span class="kw">seize</span>(<span class="st">&quot;dummy&quot;</span>, <span class="dv">1</span>)
t2 &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%<span class="st"> </span><span class="kw">timeout</span>(<span class="dv">1</span>)
t3 &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%<span class="st"> </span><span class="kw">release</span>(<span class="st">&quot;dummy&quot;</span>, <span class="dv">1</span>)

t0 &lt;-<span class="st"> </span><span class="kw">join</span>(t1, t2, t3)
t0
<span class="co">#&gt; simmer trajectory: anonymous, 3 activities</span>
<span class="co">#&gt; { Activity: Seize        | resource: dummy | amount: 1 }</span>
<span class="co">#&gt; { Activity: Timeout      | delay: 1 }</span>
<span class="co">#&gt; { Activity: Release      | resource: dummy | amount: 1 }</span></code></pre></div>
<p>Or it may operate inline, like another activity:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t0 &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%
<span class="st">  </span><span class="kw">join</span>(t1) %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">join</span>(t3)
t0
<span class="co">#&gt; simmer trajectory: anonymous, 3 activities</span>
<span class="co">#&gt; { Activity: Seize        | resource: dummy | amount: 1 }</span>
<span class="co">#&gt; { Activity: Timeout      | delay: 1 }</span>
<span class="co">#&gt; { Activity: Release      | resource: dummy | amount: 1 }</span></code></pre></div>
</div>
<div id="interacting-with-the-environment-from-within-a-trajectory" class="section level2">
<h2>Interacting with the environment from within a trajectory</h2>
<p>It is possible to interact with the simulation environment in order to extract parameters of interest such as the current simulation time (<code>now()</code>), status of resources (<code>get_capacity</code>, <code>get_queue_size</code>, <code>get_server_count</code>, <code>get_queue_count</code>), status of generators (<code>get_n_generated</code>) or directly to gather the history of monitored values (<code>get_mon_*</code>). You may also want (or in other words, your model may need) to check and use all this information to take decisions inside a given trajectory.</p>
<p>For instance, let’s suppose we just want to print the simulation time at a given point in a trajectory. The only requirement is that you must define the simulation environment <strong>before</strong> running the simulation. This won’t work:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">remove</span>(env)

t &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(function() <span class="kw">print</span>(env %&gt;%<span class="st"> </span><span class="kw">now</span>()))

env &lt;-<span class="st"> </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;dummy&quot;</span>, t, function() <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>(<span class="dv">4</span>)
<span class="co">#&gt; Error in eval(expr, envir, enclos): objeto 'env' no encontrado</span></code></pre></div>
<p>Because the global <code>env</code> is not available at runtime: the simulation runs <em>and then</em> the resulting object is assigned to <code>env</code>. We need to assign first, then run. So this will work:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(function() <span class="kw">print</span>(env %&gt;%<span class="st"> </span><span class="kw">now</span>()))

env &lt;-<span class="st"> </span><span class="kw">simmer</span>() %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;dummy&quot;</span>, t, function() <span class="dv">1</span>)

env %&gt;%<span class="st"> </span><span class="kw">run</span>(<span class="dv">4</span>)
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; [1] 2</span>
<span class="co">#&gt; [1] 3</span>
<span class="co">#&gt; simmer environment: anonymous | now: 4 | next: 4</span>
<span class="co">#&gt; { Generator: dummy | monitored: 1 | n_generated: 5 }</span></code></pre></div>
<p>And we get the expected output. However, as a general rule of good practice, <strong>it is recommended to instantiate the environment always in the first place</strong>, to avoid possible mistakes and because the code becomes more readable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First, instantiate the environment</span>
env &lt;-<span class="st"> </span><span class="kw">simmer</span>()

<span class="co"># Here I'm using it</span>
t &lt;-<span class="st"> </span><span class="kw">create_trajectory</span>() %&gt;%
<span class="st">  </span><span class="kw">timeout</span>(function() <span class="kw">print</span>(env %&gt;%<span class="st"> </span><span class="kw">now</span>()))

<span class="co"># And finally, run it</span>
env %&gt;%
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;dummy&quot;</span>, t, function() <span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">run</span>(<span class="dv">4</span>)
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; [1] 2</span>
<span class="co">#&gt; [1] 3</span>
<span class="co">#&gt; simmer environment: anonymous | now: 4 | next: 4</span>
<span class="co">#&gt; { Generator: dummy | monitored: 1 | n_generated: 5 }</span></code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
